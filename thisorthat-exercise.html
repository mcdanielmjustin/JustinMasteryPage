<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>This or That — Mastery Page</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #09090b; --accent: #9333ea; --accent-light: #c084fc; --accent-dark: #7c22d4;
      --green: #34d399; --red: #f87171; --gold: #d4a054;
      --text: #fafafa; --text2: #a8a8b3; --text3: #6b6b76;
      --border: rgba(255,255,255,0.07);
    }

    html, body { min-height:100%; background:var(--bg); color:var(--text);
      font-family:'Inter',system-ui,sans-serif; font-size:15px; line-height:1.6; overflow-x:hidden; }

    @keyframes fadeInUp { from{opacity:0;transform:translateY(16px);}to{opacity:1;transform:translateY(0);} }
    @keyframes fadeIn   { from{opacity:0;}to{opacity:1;} }
    @keyframes pulse    { 0%,100%{opacity:.1;}50%{opacity:.18;} }
    @keyframes spin     { to{transform:rotate(360deg);} }
    @keyframes pop      { 0%{transform:scale(1);}50%{transform:scale(1.06);}100%{transform:scale(1);} }

    .blob { position:fixed;border-radius:50%;filter:blur(110px);pointer-events:none;animation:pulse 7s ease-in-out infinite;z-index:0; }
    .blob-purple { width:500px;height:500px;background:#9333ea;top:-180px;right:-160px; }
    .blob-gold   { width:400px;height:400px;background:#d4a054;bottom:-140px;left:-120px;animation-delay:3.5s;opacity:.6; }

    nav {
      position:sticky;top:0;z-index:10;height:58px;
      background:rgba(9,9,11,.88);backdrop-filter:blur(20px);
      border-bottom:1px solid var(--border);
      display:flex;align-items:center;padding:0 24px;gap:14px;
    }
    .back-btn { display:flex;align-items:center;gap:6px;font-size:13px;font-weight:500;color:var(--text3);text-decoration:none;transition:color .2s; }
    .back-btn:hover { color:var(--accent-light); }
    .nav-sep { width:1px;height:18px;background:var(--border); }
    .logo-icon { width:28px;height:28px;border-radius:6px;background:linear-gradient(135deg,#9333ea,#6d28d9);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;color:#fff; }
    .logo-title { font-weight:700;font-size:14px; }
    .nav-logo { display:flex;align-items:center;gap:8px;text-decoration:none; }
    .nav-right { margin-left:auto;display:flex;align-items:center;gap:10px; }
    .session-badge { font-size:11px;font-weight:600;color:var(--text3);letter-spacing:.06em; }

    .screen { position:relative;z-index:1;display:none; }
    .screen.active { display:block; }

    #screen-loading { display:none; }
    #screen-loading.active { display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:calc(100vh - 58px);gap:16px; }
    .spinner { width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--accent-light);border-radius:50%;animation:spin .7s linear infinite; }
    .loading-text { font-size:14px;color:var(--text3); }
    .loading-progress { width:200px;height:3px;background:rgba(255,255,255,.08);border-radius:2px;overflow:hidden; }
    .loading-progress-fill { height:100%;background:var(--accent-light);border-radius:2px;transition:width .3s ease;width:0%; }

    #screen-quiz.active { display:flex;flex-direction:column;min-height:calc(100vh - 58px);padding:28px 24px 60px; }
    .quiz-inner { max-width:680px;width:100%;margin:0 auto;display:flex;flex-direction:column;gap:20px;animation:fadeInUp .4s ease-out both; }

    /* Progress */
    .progress-row { display:flex;align-items:center;gap:12px; }
    .progress-label { font-size:12px;font-weight:600;color:var(--text3);white-space:nowrap; }
    .progress-track { flex:1;height:4px;background:rgba(255,255,255,.08);border-radius:2px;overflow:hidden; }
    .progress-fill  { height:100%;background:var(--accent-light);border-radius:2px;transition:width .4s ease; }
    .progress-count { font-size:12px;font-weight:600;color:var(--text2);white-space:nowrap; }

    /* Meta */
    .meta-row { display:flex;align-items:center;gap:8px;flex-wrap:wrap; }
    .badge { font-size:11px;font-weight:700;letter-spacing:.05em;padding:3px 9px;border-radius:6px; }
    .badge-domain { background:rgba(147,51,234,.12);color:var(--accent-light);border:1px solid rgba(147,51,234,.25); }
    .badge-sub    { background:rgba(255,255,255,.05);color:var(--text3); }

    /* Timer */
    .timer-wrap { margin-left:auto;display:flex;align-items:center;gap:8px;flex-shrink:0; }
    .timer-track { width:80px;height:4px;background:rgba(255,255,255,.1);border-radius:2px;overflow:hidden; }
    .timer-fill  { height:100%;border-radius:2px;transition:background .3s; }
    .timer-fill.green  { background:var(--green); }
    .timer-fill.yellow { background:#fbbf24; }
    .timer-fill.red    { background:var(--red); }
    .timer-count { font-size:13px;font-weight:700;font-variant-numeric:tabular-nums;width:28px;text-align:right; }

    /* Concept pair header */
    .pair-header {
      background:rgba(147,51,234,.07);
      border:1px solid rgba(147,51,234,.2);
      border-radius:16px; padding:18px 22px;
      text-align:center;
    }
    .pair-vs-row { display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap; }
    .pair-label { font-size:10px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--text3);margin-bottom:10px; }
    .concept-name {
      font-family:'Instrument Serif',Georgia,serif;
      font-size:1.3rem; font-weight:400;
      color:var(--accent-light);
      padding:6px 14px;
      background:rgba(147,51,234,.12);
      border:1px solid rgba(147,51,234,.3);
      border-radius:10px;
    }
    .concept-name.hidden { color:transparent;background:rgba(255,255,255,.05);border-color:var(--border);user-select:none; }
    .vs-divider { font-size:11px;font-weight:700;letter-spacing:.08em;color:var(--text3);text-transform:uppercase; }

    /* Clue card */
    .clue-card {
      background:rgba(255,255,255,.025);
      border:1px solid var(--border);
      border-radius:16px; padding:24px 26px;
    }
    .clue-label { font-size:10px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--text3);margin-bottom:10px; }
    .clue-text  { font-family:'Instrument Serif',Georgia,serif;font-size:1.15rem;line-height:1.55;color:var(--text); }

    /* Choice buttons */
    .choices-row { display:flex;gap:12px; }
    .choice-btn {
      flex:1; padding:18px 14px;
      background:rgba(255,255,255,.025);
      border:1px solid var(--border);
      border-radius:14px; cursor:pointer;
      font-family:'Instrument Serif',Georgia,serif;
      font-size:1.1rem; color:var(--text2);
      text-align:center; user-select:none;
      transition:border-color .2s,background .2s,transform .2s,color .2s;
      display:flex; flex-direction:column; align-items:center; gap:6px;
    }
    .choice-btn:hover { background:rgba(147,51,234,.1);border-color:rgba(147,51,234,.4);color:var(--text);transform:translateY(-3px); }
    .choice-btn.correct { border-color:var(--green)!important;background:rgba(52,211,153,.1)!important;color:var(--green)!important;animation:pop .3s ease; }
    .choice-btn.wrong   { border-color:var(--red)!important;background:rgba(248,113,113,.08)!important;color:var(--red)!important; }
    .choice-btn.dimmed  { opacity:.35;cursor:default;transform:none!important; }
    .choice-check { font-size:18px;display:none; }
    .choice-btn.correct .choice-check,
    .choice-btn.wrong   .choice-check { display:block; }
    .choice-name-hidden { font-size:.85rem;color:var(--text3);font-family:'Inter',sans-serif;font-style:italic; }

    /* Answer reveal */
    .answer-reveal {
      background:rgba(255,255,255,.025);
      border:1px solid var(--border);
      border-radius:14px; padding:18px 22px;
      display:none; flex-direction:column; gap:10px;
      animation:fadeIn .3s ease-out;
    }
    .answer-reveal.visible { display:flex; }
    .reveal-distinction {
      font-size:13px; color:var(--text2); line-height:1.6;
    }
    .reveal-distinction strong { color:var(--accent-light); }
    .reveal-full { font-size:12px; color:var(--text3); line-height:1.6; }
    .reveal-toggle {
      font-size:11px;font-weight:600;color:var(--text3);
      background:none;border:none;cursor:pointer;text-align:left;
      padding:0; text-decoration:underline; transition:color .2s;
    }
    .reveal-toggle:hover { color:var(--accent-light); }
    .reveal-full-text { display:none;margin-top:4px; }
    .reveal-full-text.open { display:block; }

    /* Feedback */
    .feedback-bar { border-radius:12px;padding:12px 18px;display:none;align-items:center;gap:12px;font-size:14px;font-weight:600; }
    .feedback-bar.correct-bar { display:flex;background:rgba(52,211,153,.1);border:1px solid rgba(52,211,153,.25);color:var(--green); }
    .feedback-bar.wrong-bar   { display:flex;background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.2);color:var(--red); }
    .feedback-bar.timeout-bar { display:flex;background:rgba(255,255,255,.05);border:1px solid var(--border);color:var(--text3); }
    .feedback-icon { font-size:18px; }
    .feedback-sub  { font-size:12px;font-weight:400;opacity:.8; }

    /* Next */
    .next-btn {
      width:100%;padding:15px;
      background:linear-gradient(135deg,#c084fc,#9333ea);
      color:#fff;font-family:inherit;font-size:15px;font-weight:700;
      border:none;border-radius:14px;cursor:pointer;
      display:none;align-items:center;justify-content:center;gap:10px;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.15),0 6px 20px rgba(147,51,234,.3);
      transition:transform .2s,box-shadow .2s;
    }
    .next-btn.visible { display:flex;animation:fadeIn .3s ease-out both; }
    .next-btn:hover { transform:translateY(-2px);box-shadow:inset 0 1px 0 rgba(255,255,255,.2),0 10px 28px rgba(147,51,234,.4); }

    /* ── Results ── */
    #screen-results.active { display:flex;flex-direction:column;min-height:calc(100vh - 58px);padding:40px 24px 60px; }
    .results-inner { max-width:680px;width:100%;margin:0 auto;display:flex;flex-direction:column;gap:28px;animation:fadeInUp .5s ease-out both; }
    .results-hero { text-align:center;padding:32px 0 12px; }
    .results-hero h1 { font-family:'Instrument Serif',Georgia,serif;font-size:clamp(2.2rem,5vw,3.4rem);line-height:1.1; }
    .results-hero h1 em { font-style:italic;color:var(--accent-light); }
    .results-score-ring { margin:20px auto 0;width:120px;height:120px; }
    .results-score-ring svg { width:100%;height:100%;transform:rotate(-90deg); }
    .score-track { fill:none;stroke:rgba(255,255,255,.07);stroke-width:8; }
    .score-fill  { fill:none;stroke:var(--accent-light);stroke-width:8;stroke-linecap:round;transition:stroke-dashoffset .8s ease; }
    .score-text-wrap { position:relative;top:-90px;text-align:center; }
    .score-big  { font-family:'Instrument Serif',serif;font-size:2rem;color:var(--accent-light);line-height:1; }
    .score-of   { font-size:12px;color:var(--text3);margin-top:2px; }

    .results-summary { background:rgba(255,255,255,.025);border:1px solid rgba(147,51,234,.2);border-radius:16px;padding:20px 24px;display:flex;gap:24px;flex-wrap:wrap;justify-content:space-around; }
    .rs-item { display:flex;flex-direction:column;gap:4px;align-items:center; }
    .rs-label { font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.08em; }
    .rs-val   { font-family:'Instrument Serif',serif;font-size:1.4rem;color:var(--accent-light); }

    .domain-breakdown { display:flex;flex-direction:column;gap:10px; }
    .db-label { font-size:11px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--text3);margin-bottom:4px; }
    .db-row { background:rgba(255,255,255,.025);border:1px solid var(--border);border-radius:12px;padding:12px 16px;display:flex;align-items:center;gap:14px; }
    .db-domain { font-size:11px;font-weight:700;color:var(--accent-light);width:44px;flex-shrink:0; }
    .db-track  { flex:1;height:6px;background:rgba(255,255,255,.07);border-radius:3px;overflow:hidden; }
    .db-fill   { height:100%;border-radius:3px;background:var(--accent-light);transition:width .8s .2s ease; }
    .db-fill.high { background:var(--green); }
    .db-fill.mid  { background:#fbbf24; }
    .db-fill.low  { background:var(--red); }
    .db-score  { font-size:12px;font-weight:600;color:var(--text2);white-space:nowrap;width:44px;text-align:right; }

    .results-actions { display:flex;gap:12px;flex-wrap:wrap; }
    .btn-primary { flex:1;padding:14px;min-width:140px;background:linear-gradient(135deg,#c084fc,#9333ea);color:#fff;font-family:inherit;font-size:14px;font-weight:700;border:none;border-radius:12px;cursor:pointer;box-shadow:0 4px 16px rgba(147,51,234,.25);transition:transform .2s,box-shadow .2s; }
    .btn-primary:hover { transform:translateY(-2px);box-shadow:0 8px 24px rgba(147,51,234,.4); }
    .btn-secondary { flex:1;padding:14px;min-width:140px;background:rgba(255,255,255,.04);border:1px solid var(--border);color:var(--text2);font-family:inherit;font-size:14px;font-weight:600;border-radius:12px;cursor:pointer;transition:border-color .2s,background .2s; }
    .btn-secondary:hover { background:rgba(255,255,255,.07);border-color:rgba(147,51,234,.3); }

    @media (max-width:600px) {
      #screen-quiz.active,#screen-results.active { padding:20px 16px 60px; }
      .choices-row { flex-direction:column; }
      .clue-card { padding:18px; }
    }
  </style>
</head>
<body>

  <div class="blob blob-purple"></div>
  <div class="blob blob-gold"></div>

  <nav>
    <a href="thisorthat-settings.html" class="back-btn">← Settings</a>
    <div class="nav-sep"></div>
    <a href="index.html" class="nav-logo">
      <div class="logo-icon">M</div>
      <span class="logo-title">MasteryPage</span>
    </a>
    <div class="nav-right">
      <span class="session-badge">This or That</span>
    </div>
  </nav>

  <div id="screen-loading" class="screen active">
    <div class="spinner"></div>
    <p class="loading-text" id="loading-text">Loading questions…</p>
    <div class="loading-progress"><div class="loading-progress-fill" id="loading-progress-fill"></div></div>
  </div>

  <div id="screen-quiz" class="screen">
    <div class="quiz-inner">
      <div class="progress-row">
        <span class="progress-label">Progress</span>
        <div class="progress-track"><div class="progress-fill" id="progress-fill"></div></div>
        <span class="progress-count" id="progress-count">1 / 10</span>
      </div>
      <div class="meta-row" id="meta-row"></div>

      <div class="pair-header" id="pair-header">
        <div class="pair-label">Concept Pair</div>
        <div class="pair-vs-row" id="pair-vs-row"><!-- filled by JS --></div>
      </div>

      <div class="clue-card">
        <div class="clue-label">Which concept does this describe?</div>
        <div class="clue-text" id="clue-text"></div>
      </div>

      <div class="choices-row" id="choices-row"><!-- filled by JS --></div>

      <div class="answer-reveal" id="answer-reveal">
        <div class="reveal-distinction" id="reveal-distinction"></div>
        <button class="reveal-toggle" onclick="toggleFullAnswer()">Show full explanation ↓</button>
        <div class="reveal-full-text" id="reveal-full-text"></div>
      </div>

      <div class="feedback-bar" id="feedback-bar">
        <span class="feedback-icon" id="feedback-icon"></span>
        <div>
          <div id="feedback-msg"></div>
          <div class="feedback-sub" id="feedback-sub"></div>
        </div>
      </div>

      <button class="next-btn" id="next-btn" onclick="nextQuestion()">
        <span id="next-label">Next Pair</span> →
      </button>
    </div>
  </div>

  <div id="screen-results" class="screen">
    <div class="results-inner">
      <div class="results-hero">
        <div class="results-score-ring">
          <svg viewBox="0 0 120 120">
            <circle class="score-track" cx="60" cy="60" r="52"/>
            <circle class="score-fill" id="score-fill" cx="60" cy="60" r="52"
              stroke-dasharray="326.7" stroke-dashoffset="326.7"/>
          </svg>
          <div class="score-text-wrap">
            <div class="score-big" id="score-big">—</div>
            <div class="score-of" id="score-of">correct</div>
          </div>
        </div>
        <h1 id="results-heading">Session <em>Complete</em></h1>
      </div>
      <div class="results-summary" id="results-summary"></div>
      <div class="domain-breakdown">
        <div class="db-label">Score by Domain</div>
        <div id="domain-rows"></div>
      </div>
      <div class="results-actions">
        <button class="btn-primary" onclick="location.href='thisorthat-settings.html'">New Session</button>
        <button class="btn-secondary" onclick="location.href=location.href">Try Again</button>
      </div>
    </div>
  </div>

  <script>
  const MODULE = 'thisorthat';
  const DATA_BASE = 'data/';
  const ALL_DOMAINS = ['PMET','LDEV','CPAT','PTHE','SOCU','WDEV','BPSY','CASS','PETH'];

  const sp = new URLSearchParams(location.search);
  const CFG = {
    domains: sp.get('domains') === 'mixed' ? ALL_DOMAINS : (sp.get('domains') || ALL_DOMAINS.join(',')).split(','),
    count:   parseInt(sp.get('count')) || 10,
    order:   sp.get('order') || 'shuffled',
    timer:   sp.get('timer') || 'off',
    display: sp.get('display') || 'labeled',
  };
  const timerSec = parseInt(CFG.timer) || 0;

  let questions=[], current=0, answered=false, timerInterval=null, timerLeft=0;
  const domainScores={}, sessionAnswers=[];

  // Per-question flashcard: which side to show as the clue
  let currentClue = null; // { clue, correct, wrong }

  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}return arr; }
  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function getStoredScores(){ try{return JSON.parse(localStorage.getItem('mastery_scores')||'{}');}catch{return{};} }
  function saveScores(){ const all=getStoredScores();all[MODULE]=domainScores;localStorage.setItem('mastery_scores',JSON.stringify(all)); }

  /**
   * Parse key_distinction to extract one concept's description.
   * Typical format: "Agonist = activates; Antagonist = blocks."
   * Returns { clue, correct, wrong } or null if parsing fails.
   */
  function makeFlashcard(q) {
    const kd = q.key_distinction || '';
    // Split on semicolons or em-dashes
    const parts = kd.replace(/\.$/, '').split(/;|—|–/).map(s => s.trim()).filter(Boolean);
    const map = {};
    for (const part of parts) {
      const eqIdx = part.indexOf('=');
      if (eqIdx === -1) continue;
      const concept = part.substring(0, eqIdx).trim();
      const desc    = part.substring(eqIdx + 1).trim();
      map[concept] = desc;
    }

    // Try to match item_x and item_y (case-insensitive partial match)
    let xDesc = null, yDesc = null;
    for (const [k, v] of Object.entries(map)) {
      if (k.toLowerCase().includes(q.item_x.toLowerCase()) || q.item_x.toLowerCase().includes(k.toLowerCase())) xDesc = v;
      else if (k.toLowerCase().includes(q.item_y.toLowerCase()) || q.item_y.toLowerCase().includes(k.toLowerCase())) yDesc = v;
    }

    // Pick which side to show (randomly), fallback to full key_distinction
    if (xDesc || yDesc) {
      const showX = xDesc && (!yDesc || Math.random() < 0.5);
      return showX
        ? { clue: xDesc, correct: q.item_x, wrong: q.item_y }
        : { clue: yDesc, correct: q.item_y, wrong: q.item_x };
    }

    // Fallback: show the question itself as a clue, ask to identify item_x
    return {
      clue: q.key_distinction || q.question,
      correct: Math.random() < 0.5 ? q.item_x : q.item_y,
      wrong:   Math.random() < 0.5 ? q.item_x : q.item_y, // will be fixed below
    };
  }

  // ── Load questions ──────────────────────────────────────────────────────────
  async function loadQuestions() {
    const progressFill = document.getElementById('loading-progress-fill');
    const loadingText  = document.getElementById('loading-text');
    let pool = [];
    for (let i = 0; i < CFG.domains.length; i++) {
      const d = CFG.domains[i];
      loadingText.textContent = `Loading ${d}… (${i + 1}/${CFG.domains.length})`;
      progressFill.style.width = ((i / CFG.domains.length) * 100) + '%';
      try {
        const r = await fetch(`${DATA_BASE}${d}_contrast.json`).then(r => r.ok ? r.json() : null);
        if (r && r.questions) pool = pool.concat(r.questions);
      } catch {}
    }
    progressFill.style.width = '100%';

    if (!pool.length) {
      loadingText.textContent = 'No questions found for selected domains.';
      return;
    }

    // Init domain scores
    for (const d of CFG.domains) {
      const prev = (getStoredScores()[MODULE] || {})[d];
      domainScores[d] = prev ? { ...prev, sessionCorrect:0, sessionTotal:0 } : { correct:0, total:0, sessionCorrect:0, sessionTotal:0 };
    }

    // Order
    if (CFG.order === 'weakest') {
      const prevScores = (getStoredScores()[MODULE] || {});
      const byDomain = {};
      for (const q of pool) {
        if (!byDomain[q.domain_code]) byDomain[q.domain_code] = [];
        byDomain[q.domain_code].push(q);
      }
      const domainOrder = Object.keys(byDomain).sort((a, b) => {
        const aS = prevScores[a], bS = prevScores[b];
        const aA = aS && aS.total ? aS.correct / aS.total : 0.5;
        const bA = bS && bS.total ? bS.correct / bS.total : 0.5;
        return aA - bA;
      });
      pool = domainOrder.flatMap(d => shuffle(byDomain[d]));
    } else if (CFG.order === 'sequential') {
      pool.sort((a, b) => (a.subdomain || '').localeCompare(b.subdomain || ''));
    } else {
      shuffle(pool);
    }

    questions = pool.slice(0, CFG.count);
    document.getElementById('screen-loading').classList.remove('active');
    document.getElementById('screen-quiz').classList.add('active');
    renderQuestion();
  }

  // ── Render ─────────────────────────────────────────────────────────────────
  function renderQuestion() {
    answered = false;
    const q = questions[current];
    const total = questions.length;

    // Progress
    document.getElementById('progress-fill').style.width = (current / total * 100) + '%';
    document.getElementById('progress-count').textContent = `${current + 1} / ${total}`;

    // Meta
    document.getElementById('meta-row').innerHTML = `
      <span class="badge badge-domain">${q.domain_code}</span>
      <span class="badge badge-sub">${q.subdomain || ''}</span>
      ${timerSec ? `<div class="timer-wrap"><div class="timer-track"><div class="timer-fill green" id="timer-fill"></div></div><span class="timer-count" id="timer-count">${timerSec}</span></div>` : ''}
    `;

    // Build flashcard
    currentClue = makeFlashcard(q);

    // Concept pair header
    const isLabeled = CFG.display === 'labeled';
    document.getElementById('pair-vs-row').innerHTML = `
      <span class="concept-name${isLabeled ? '' : ' hidden'}">${isLabeled ? escapeHtml(q.item_x) : '???'}</span>
      <span class="vs-divider">vs</span>
      <span class="concept-name${isLabeled ? '' : ' hidden'}">${isLabeled ? escapeHtml(q.item_y) : '???'}</span>
    `;

    // Clue
    document.getElementById('clue-text').textContent = currentClue.clue;

    // Choice buttons (randomize left/right order)
    const choices = [
      { name: currentClue.correct, isCorrect: true },
      { name: currentClue.wrong,   isCorrect: false },
    ];
    if (Math.random() < 0.5) choices.reverse();

    const row = document.getElementById('choices-row');
    row.innerHTML = '';
    for (const c of choices) {
      const btn = document.createElement('button');
      btn.className = 'choice-btn';
      btn.dataset.correct = c.isCorrect ? '1' : '0';
      if (isLabeled) {
        btn.innerHTML = `<span>${escapeHtml(c.name)}</span><span class="choice-check"></span>`;
      } else {
        btn.innerHTML = `<span class="choice-name-hidden">Choose</span><span class="choice-check"></span>`;
        btn.dataset.name = c.name;
      }
      btn.onclick = () => selectAnswer(btn, c.isCorrect, c.name);
      row.appendChild(btn);
    }

    // Reset UI
    document.getElementById('answer-reveal').classList.remove('visible');
    document.getElementById('reveal-full-text').classList.remove('open');
    document.getElementById('feedback-bar').className = 'feedback-bar';
    document.getElementById('next-btn').classList.remove('visible');
    document.getElementById('next-label').textContent = current < questions.length - 1 ? 'Next Pair' : 'See Results';

    if (timerSec) startTimer();
  }

  // ── Timer ──────────────────────────────────────────────────────────────────
  function startTimer() {
    timerLeft = timerSec; clearInterval(timerInterval);
    updateTimerUI();
    timerInterval = setInterval(() => {
      timerLeft--; updateTimerUI();
      if (timerLeft <= 0) { clearInterval(timerInterval); if (!answered) timeoutQuestion(); }
    }, 1000);
  }
  function updateTimerUI() {
    const fill = document.getElementById('timer-fill'), count = document.getElementById('timer-count');
    if (!fill || !count) return;
    const pct = (timerLeft / timerSec) * 100;
    fill.style.width = pct + '%';
    fill.className = 'timer-fill ' + (pct > 50 ? 'green' : pct > 25 ? 'yellow' : 'red');
    count.textContent = timerLeft;
    count.style.color = pct > 25 ? 'var(--text2)' : 'var(--red)';
  }
  function timeoutQuestion() {
    if (answered) return; answered = true;
    // Reveal correct
    document.querySelectorAll('.choice-btn').forEach(btn => {
      btn.classList.add(btn.dataset.correct === '1' ? 'correct' : 'dimmed');
      revealBlindNames();
    });
    recordAnswer(false); revealAnswer(); showFeedback('timeout');
  }

  // ── Answer ─────────────────────────────────────────────────────────────────
  function selectAnswer(btn, isCorrect, name) {
    if (answered) return; answered = true; clearInterval(timerInterval);

    document.querySelectorAll('.choice-btn').forEach(b => {
      if (b.dataset.correct === '1') { b.classList.add('correct'); b.querySelector('.choice-check').textContent = '✓'; }
      else if (b === btn && !isCorrect) { b.classList.add('wrong'); b.querySelector('.choice-check').textContent = '✗'; }
      else { b.classList.add('dimmed'); }
    });

    if (CFG.display === 'blind') revealBlindNames();
    recordAnswer(isCorrect); revealAnswer(); showFeedback(isCorrect ? 'correct' : 'wrong');
  }

  function revealBlindNames() {
    const q = questions[current];
    const btns = document.querySelectorAll('.choice-btn');
    btns.forEach(btn => {
      const nameEl = btn.querySelector('.choice-name-hidden');
      if (nameEl) { nameEl.className = ''; nameEl.textContent = btn.dataset.name || ''; }
    });
    // Also reveal pair header
    document.querySelectorAll('.concept-name.hidden').forEach(el => {
      el.classList.remove('hidden');
    });
    document.getElementById('pair-vs-row').innerHTML = `
      <span class="concept-name">${escapeHtml(q.item_x)}</span>
      <span class="vs-divider">vs</span>
      <span class="concept-name">${escapeHtml(q.item_y)}</span>
    `;
  }

  function recordAnswer(isCorrect) {
    const code = questions[current].domain_code;
    if (!domainScores[code]) domainScores[code] = { correct:0, total:0, sessionCorrect:0, sessionTotal:0 };
    domainScores[code].total++; domainScores[code].sessionTotal++;
    if (isCorrect) { domainScores[code].correct++; domainScores[code].sessionCorrect++; }
    sessionAnswers.push({ id: questions[current].id, correct: isCorrect, domain: code });
  }

  function revealAnswer() {
    const q = questions[current];
    const rev = document.getElementById('answer-reveal');
    document.getElementById('reveal-distinction').innerHTML =
      `<strong>Key Distinction:</strong> ${escapeHtml(q.key_distinction || '')}`;
    document.getElementById('reveal-full-text').textContent = q.answer || '';
    rev.classList.add('visible');
  }

  function toggleFullAnswer() {
    const el = document.getElementById('reveal-full-text');
    const btn = document.querySelector('.reveal-toggle');
    el.classList.toggle('open');
    btn.textContent = el.classList.contains('open') ? 'Hide explanation ↑' : 'Show full explanation ↓';
  }

  function showFeedback(type) {
    const fb = document.getElementById('feedback-bar');
    const icon = document.getElementById('feedback-icon');
    const msg  = document.getElementById('feedback-msg');
    const sub  = document.getElementById('feedback-sub');
    if (type === 'correct') {
      fb.className = 'feedback-bar correct-bar'; icon.textContent = '✓'; msg.textContent = 'Correct!'; sub.textContent = currentClue.correct;
    } else if (type === 'wrong') {
      fb.className = 'feedback-bar wrong-bar'; icon.textContent = '✗'; msg.textContent = 'Not quite —'; sub.textContent = `The answer is ${currentClue.correct}.`;
    } else {
      fb.className = 'feedback-bar timeout-bar'; icon.textContent = '⏱'; msg.textContent = "Time's up!"; sub.textContent = `The answer is ${currentClue.correct}.`;
    }
    document.getElementById('next-btn').classList.add('visible');
  }

  // ── Navigation ─────────────────────────────────────────────────────────────
  function nextQuestion() {
    current++;
    if (current >= questions.length) { saveScores(); showResults(); }
    else {
      const qi = document.querySelector('.quiz-inner');
      qi.style.animation = 'none';
      requestAnimationFrame(() => { qi.style.animation = ''; renderQuestion(); });
    }
  }

  // ── Results ────────────────────────────────────────────────────────────────
  function showResults() {
    document.getElementById('screen-quiz').classList.remove('active');
    document.getElementById('screen-results').classList.add('active');

    const total   = sessionAnswers.length;
    const correct = sessionAnswers.filter(a => a.correct).length;
    const pct     = total ? Math.round(correct / total * 100) : 0;

    const circ = 2 * Math.PI * 52;
    setTimeout(() => { document.getElementById('score-fill').style.strokeDashoffset = circ - (circ * pct / 100); }, 100);
    document.getElementById('score-big').textContent = `${correct}/${total}`;
    document.getElementById('score-of').textContent  = `${pct}% correct`;

    const h = document.getElementById('results-heading');
    if (pct >= 80) h.innerHTML = 'Great <em>Work!</em>';
    else if (pct >= 60) h.innerHTML = 'Session <em>Complete</em>';
    else h.innerHTML = 'Keep <em>Practicing</em>';

    document.getElementById('results-summary').innerHTML = `
      <div class="rs-item"><span class="rs-label">Score</span><span class="rs-val">${pct}%</span></div>
      <div class="rs-item"><span class="rs-label">Correct</span><span class="rs-val">${correct}/${total}</span></div>
      <div class="rs-item"><span class="rs-label">Domains</span><span class="rs-val">${CFG.domains.length}</span></div>
    `;

    const rows = document.getElementById('domain-rows');
    rows.innerHTML = '';
    const domainsUsed = [...new Set(sessionAnswers.map(a => a.domain))].sort();
    for (const d of domainsUsed) {
      const s = domainScores[d] || { sessionCorrect:0, sessionTotal:0 };
      const sc = s.sessionCorrect||0, st = s.sessionTotal||0;
      const dp = st ? Math.round(sc/st*100) : 0;
      const cls = dp >= 75 ? 'high' : dp >= 50 ? 'mid' : 'low';
      rows.innerHTML += `<div class="db-row"><span class="db-domain">${d}</span><div class="db-track"><div class="db-fill ${cls}" style="width:0%" data-pct="${dp}"></div></div><span class="db-score">${sc}/${st}</span></div>`;
    }
    setTimeout(() => { rows.querySelectorAll('.db-fill').forEach(el => el.style.width = el.dataset.pct + '%'); }, 200);
  }

  // ── Boot ───────────────────────────────────────────────────────────────────
  loadQuestions().catch(err => {
    document.querySelector('.loading-text').textContent = 'Error: ' + err.message;
  });
  </script>

</body>
</html>
