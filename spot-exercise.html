<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spot the Error | MasteryPage</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #09090b;
      --bg2: #0f0f11;
      --bg3: #18181b;
      --card: #1c1c1f;
      --teal: #2dd4bf;
      --teal-light: #5eead4;
      --teal-dark: #0d9488;
      --text: #fafafa;
      --text2: #a8a8b3;
      --text3: #6b6b76;
      --border: rgba(255,255,255,0.07);
      --green: #34d399;
      --red: #f87171;
      --amber: #fbbf24;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, sans-serif;
      min-height: 100vh;
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(16px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes correctPulse {
      0%   { box-shadow: 0 0 0 0 rgba(52,211,153,0.5); }
      60%  { box-shadow: 0 0 0 10px rgba(52,211,153,0); }
      100% { box-shadow: none; }
    }
    @keyframes wrongShake {
      0%,100% { transform: translateX(0); }
      20%     { transform: translateX(-6px); }
      40%     { transform: translateX(6px); }
      60%     { transform: translateX(-4px); }
      80%     { transform: translateX(4px); }
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes highlightPop {
      0%   { background-color: rgba(251,191,36,0.0); }
      40%  { background-color: rgba(251,191,36,0.45); }
      100% { background-color: rgba(251,191,36,0.22); }
    }

    /* NAV */
    nav {
      position: fixed; top:0; left:0; right:0; z-index:10; height:60px;
      background: rgba(9,9,11,0.9); backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; padding: 0 24px; gap: 16px;
    }
    .logo { display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit; }
    .logo-icon {
      width:32px; height:32px; border-radius:8px;
      background: linear-gradient(135deg,#9333ea,#6d28d9);
      display:flex; align-items:center; justify-content:center;
      font-weight:700; font-size:15px; color:#fff;
    }
    .logo-title { font-weight:700; font-size:14px; }
    .nav-spacer { flex: 1; }
    .nav-meta  { font-size: 12px; color: var(--text3); text-align: right; }
    .nav-score { font-weight: 600; color: var(--teal-light); font-size: 14px; }

    /* MAIN LAYOUT */
    .page {
      padding-top: 60px;
      min-height: 100vh;
      display: flex; flex-direction: column; align-items: center;
    }

    /* PROGRESS BAR */
    .progress-wrap { width: 100%; height: 3px; background: rgba(255,255,255,0.06); }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--teal-dark), var(--teal-light));
      transition: width 0.4s ease;
    }

    /* LOADING */
    #screen-loading {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; gap: 16px;
      padding: 80px 24px; width: 100%;
    }
    .loading-text { font-size: 14px; color: var(--text2); }
    .spinner {
      width: 32px; height: 32px;
      border: 2px solid var(--border);
      border-top-color: var(--teal);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* QUIZ SCREEN */
    #screen-quiz {
      display: none;
      width: 100%; max-width: 780px;
      padding: 32px 24px 80px;
      animation: fadeInUp 0.4s ease-out both;
    }

    .q-meta {
      display: flex; align-items: center; gap: 10px;
      margin-bottom: 20px; flex-wrap: wrap;
    }
    .q-num {
      font-size: 11px; font-weight: 600; letter-spacing: 0.08em;
      color: var(--text3); text-transform: uppercase;
    }
    .q-badge {
      font-size: 10px; font-weight: 600; letter-spacing: 0.08em;
      text-transform: uppercase; padding: 3px 10px;
      border-radius: 20px; border: 1px solid;
    }
    .badge-teal { color: var(--teal-light); border-color: rgba(45,212,191,0.35); background: rgba(45,212,191,0.08); }

    .q-chapter { font-size: 12px; color: var(--text3); margin-bottom: 6px; }
    .q-section  { font-size: 11px; color: var(--text3); margin-bottom: 20px; }

    /* Generic question body */
    #question-body { margin-bottom: 8px; }

    /* Passage card (used by mc and passage_click) */
    .passage-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px 26px;
      margin-bottom: 16px;
    }
    .passage-label {
      font-size: 10px; font-weight: 600; letter-spacing: 0.1em;
      text-transform: uppercase; color: var(--teal);
      margin-bottom: 14px;
    }
    .passage-text {
      font-size: 15px;
      line-height: 1.75;
      color: var(--text2);
    }
    /* Error highlight — appears after answering */
    mark.error-highlight {
      background-color: rgba(251,191,36,0.22);
      color: #fde68a;
      border-radius: 3px;
      padding: 1px 4px;
      font-weight: 600;
      border-bottom: 2px solid rgba(251,191,36,0.55);
      animation: highlightPop 0.5s ease-out both;
      display: inline;
    }
    .passage-instruction {
      font-size: 12px; color: var(--text3);
      margin-top: 14px; font-style: italic;
    }

    /* ── MC options ──────────────────────────────────────────────────────── */
    .options-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 8px; }
    .option-btn {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 18px;
      text-align: left;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      display: flex; align-items: flex-start; gap: 12px;
    }
    .option-btn:hover:not(:disabled) {
      border-color: rgba(45,212,191,0.4);
      background: rgba(45,212,191,0.06);
    }
    .option-btn:disabled { cursor: default; }
    .opt-letter {
      width: 24px; height: 24px; border-radius: 6px;
      background: var(--bg3);
      display: flex; align-items: center; justify-content: center;
      font-size: 11px; font-weight: 700; color: var(--text3);
      flex-shrink: 0; margin-top: 1px;
    }
    .opt-text { font-size: 13px; color: var(--text2); line-height: 1.5; }

    /* Feedback states */
    .option-btn.correct {
      border-color: var(--green);
      background: rgba(52,211,153,0.08);
      animation: correctPulse 0.6s ease-out;
    }
    .option-btn.correct .opt-letter { background: rgba(52,211,153,0.2); color: var(--green); }
    .option-btn.correct .opt-text   { color: var(--text); }
    .option-btn.wrong {
      border-color: var(--red);
      background: rgba(248,113,113,0.08);
      animation: wrongShake 0.4s ease-out;
    }
    .option-btn.wrong .opt-letter { background: rgba(248,113,113,0.2); color: var(--red); }
    .option-btn.reveal {
      border-color: rgba(52,211,153,0.4);
      background: rgba(52,211,153,0.05);
    }
    .option-btn.reveal .opt-letter { background: rgba(52,211,153,0.15); color: var(--green); }

    /* ── passage_click mode ──────────────────────────────────────────────── */
    .passage-sentences { display: flex; flex-direction: column; gap: 8px; }
    .clickable-sentence {
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
      line-height: 1.75;
      color: var(--text2);
      transition: border-color 0.2s, background 0.2s;
    }
    .clickable-sentence:hover:not(.sentence-correct):not(.sentence-wrong) {
      border-color: rgba(45,212,191,0.45);
      background: rgba(45,212,191,0.05);
    }
    .clickable-sentence.sentence-correct {
      border-color: var(--green);
      background: rgba(52,211,153,0.08);
      animation: correctPulse 0.6s ease-out;
      color: var(--text);
    }
    .clickable-sentence.sentence-wrong {
      border-color: var(--red);
      background: rgba(248,113,113,0.08);
      animation: wrongShake 0.4s ease-out;
    }

    /* ── sentence_click mode ─────────────────────────────────────────────── */
    .phrase-container {
      font-size: 15px;
      line-height: 1.75;
      color: var(--text2);
    }
    .clickable-phrase {
      cursor: pointer;
      padding: 2px 1px;
      border-bottom: 1.5px dashed rgba(255,255,255,0.22);
      transition: border-color 0.15s, background 0.15s, color 0.15s;
    }
    .clickable-phrase:hover:not(.phrase-correct):not(.phrase-wrong) {
      background: rgba(45,212,191,0.12);
      color: var(--teal-light);
      border-bottom: 1.5px solid var(--teal);
    }
    .clickable-phrase.phrase-correct {
      background: rgba(251,191,36,0.22);
      color: #fde68a;
      border-bottom: 2px solid rgba(251,191,36,0.55);
      animation: highlightPop 0.5s ease-out both;
    }
    .clickable-phrase.phrase-wrong {
      background: rgba(248,113,113,0.15);
      color: var(--red);
      animation: wrongShake 0.4s ease-out;
      border-radius: 3px;
    }

    /* ── vocab mode ──────────────────────────────────────────────────────── */
    .vocab-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 8px;
    }
    .vocab-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .vocab-card:hover:not(.vocab-correct):not(.vocab-wrong) {
      border-color: rgba(45,212,191,0.4);
      background: rgba(45,212,191,0.06);
    }
    .vocab-card.vocab-correct {
      border-color: var(--green);
      background: rgba(52,211,153,0.08);
      animation: correctPulse 0.6s ease-out;
    }
    .vocab-card.vocab-wrong {
      border-color: var(--red);
      background: rgba(248,113,113,0.08);
      animation: wrongShake 0.4s ease-out;
    }
    .vocab-term {
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 8px;
    }
    .vocab-def {
      font-size: 12px;
      color: var(--text2);
      line-height: 1.6;
    }

    /* Keyboard hint */
    .kbd-hint {
      font-size: 11px; color: var(--text3);
      text-align: center; margin-bottom: 20px;
    }
    kbd {
      background: var(--bg3);
      border: 1px solid rgba(255,255,255,0.12);
      border-bottom-width: 2px;
      border-radius: 4px;
      padding: 1px 6px;
      font-size: 10px;
      font-family: inherit;
      color: var(--text3);
    }

    /* Feedback panel */
    .feedback-panel {
      display: none;
      border-radius: 14px;
      padding: 18px 20px;
      margin-bottom: 20px;
      animation: fadeIn 0.3s ease-out both;
    }
    .feedback-panel.correct { background: rgba(52,211,153,0.08); border: 1px solid rgba(52,211,153,0.3); }
    .feedback-panel.wrong   { background: rgba(248,113,113,0.08); border: 1px solid rgba(248,113,113,0.3); }
    .feedback-header { font-size: 13px; font-weight: 700; margin-bottom: 8px; }
    .feedback-panel.correct .feedback-header { color: var(--green); }
    .feedback-panel.wrong   .feedback-header { color: var(--red); }
    .feedback-body { font-size: 13px; color: var(--text2); line-height: 1.6; }
    .feedback-error-info {
      margin-top: 12px; padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.07);
      font-size: 12px; color: var(--text3);
    }
    .feedback-error-info strong { color: var(--text2); }

    .next-btn {
      width: 100%;
      background: linear-gradient(135deg, var(--teal-dark), #0f766e);
      border: none; border-radius: 12px;
      padding: 14px;
      font-size: 14px; font-weight: 700; color: #fff;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.15s;
      display: none;
    }
    .next-btn:hover { opacity: 0.9; transform: translateY(-1px); }

    /* RESULTS SCREEN */
    #screen-results {
      display: none;
      flex-direction: column; align-items: center;
      padding: 60px 24px;
      animation: fadeInUp 0.5s ease-out both;
    }
    .results-icon { font-size: 56px; margin-bottom: 20px; }
    .results-title {
      font-family: 'Instrument Serif', Georgia, serif;
      font-size: 2.4rem; margin-bottom: 8px; text-align: center;
    }
    .results-sub { font-size: 15px; color: var(--text2); margin-bottom: 32px; text-align: center; }
    .score-ring-wrap { margin-bottom: 36px; }
    .score-ring {
      width: 140px; height: 140px; border-radius: 50%;
      background: conic-gradient(var(--teal) var(--pct, 0%), rgba(255,255,255,0.07) 0);
      display: flex; align-items: center; justify-content: center;
    }
    .score-ring-inner {
      width: 108px; height: 108px; border-radius: 50%;
      background: var(--bg);
      display: flex; align-items: center; justify-content: center;
      flex-direction: column; gap: 2px;
    }
    .score-pct  { font-size: 1.8rem; font-weight: 700; color: var(--teal-light); }
    .score-frac { font-size: 11px; color: var(--text3); }
    .stats-row  {
      display: flex; gap: 24px; margin-bottom: 36px;
      flex-wrap: wrap; justify-content: center;
    }
    .stat-box {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px 24px; text-align: center; min-width: 100px;
    }
    .stat-n     { font-size: 1.6rem; font-weight: 700; color: var(--teal-light); }
    .stat-label { font-size: 11px; color: var(--text3); margin-top: 4px; }
    .results-btns { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; }

    .btn-outline {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 12px; padding: 12px 24px;
      font-size: 13px; font-weight: 600; color: var(--text2);
      cursor: pointer; transition: border-color 0.2s, color 0.2s;
      text-decoration: none; display: inline-block;
    }
    .btn-outline:hover { border-color: var(--teal); color: var(--teal-light); }
    .btn-primary {
      background: linear-gradient(135deg, var(--teal-dark), #0f766e);
      border: none; border-radius: 12px; padding: 12px 24px;
      font-size: 13px; font-weight: 700; color: #fff;
      cursor: pointer; transition: opacity 0.2s;
    }
    .btn-primary:hover { opacity: 0.9; }

    /* REVIEW MISSED SCREEN */
    #screen-review {
      display: none;
      width: 100%; max-width: 780px;
      padding: 32px 24px 80px;
      animation: fadeInUp 0.4s ease-out both;
    }
    .review-header {
      display: flex; align-items: center; gap: 16px;
      margin-bottom: 28px; flex-wrap: wrap;
    }
    .review-title {
      font-family: 'Instrument Serif', Georgia, serif;
      font-size: 1.6rem;
    }
    .review-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 22px 24px;
      margin-bottom: 20px;
      animation: fadeInUp 0.35s ease-out both;
    }
    .review-card-meta {
      display: flex; gap: 8px; align-items: center;
      flex-wrap: wrap; margin-bottom: 10px;
    }
    .review-card-chapter { font-size: 11px; color: var(--text3); }
    .review-passage {
      font-size: 14px; line-height: 1.75; color: var(--text2);
      background: rgba(0,0,0,0.2);
      border-radius: 10px; padding: 14px 16px;
      margin-bottom: 14px;
    }
    .review-answer-row { display: flex; flex-direction: column; gap: 8px; margin-bottom: 14px; }
    .review-choice {
      font-size: 12px; padding: 10px 14px;
      border-radius: 10px; line-height: 1.5;
    }
    .review-choice.wrong {
      background: rgba(248,113,113,0.1); color: var(--red);
      border: 1px solid rgba(248,113,113,0.25);
    }
    .review-choice.correct {
      background: rgba(52,211,153,0.1); color: var(--green);
      border: 1px solid rgba(52,211,153,0.25);
    }
    .review-explanation {
      font-size: 12px; color: var(--text2); line-height: 1.65;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.06);
    }
    .review-error-line {
      font-size: 11px; color: var(--text3); margin-top: 8px;
    }
    .review-error-line strong { color: var(--text2); }

    /* Review vocab grid — smaller cards */
    .review-vocab-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 14px;
    }
    .review-vocab-grid .vocab-card {
      font-size: 12px;
      padding: 12px;
      pointer-events: none;
    }
    .review-vocab-grid .vocab-term { font-size: 12px; }
    .review-vocab-grid .vocab-def  { font-size: 11px; }

    /* Review sentences */
    .review-sentences { display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px; }
    .review-sentence {
      font-size: 13px; line-height: 1.7; color: var(--text2);
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      pointer-events: none;
    }
    .review-sentence.sentence-correct {
      border-color: rgba(52,211,153,0.4);
      background: rgba(52,211,153,0.06);
    }

    @media (max-width: 600px) {
      .vocab-grid, .review-vocab-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <nav>
    <a class="logo" href="index.html">
      <div class="logo-icon">M</div>
      <span class="logo-title">MasteryPage</span>
    </a>
    <div class="nav-spacer"></div>
    <div>
      <div class="nav-score" id="nav-score">0 / 0</div>
      <div class="nav-meta"  id="nav-meta">Loading...</div>
    </div>
  </nav>

  <div class="page">

    <div class="progress-wrap">
      <div class="progress-fill" id="progress-fill" style="width:0%"></div>
    </div>

    <!-- Loading -->
    <div id="screen-loading">
      <div class="spinner"></div>
      <div class="loading-text">Loading questions&hellip;</div>
    </div>

    <!-- Quiz -->
    <div id="screen-quiz">

      <div class="q-meta">
        <span class="q-num"         id="q-num">Question 1 of 20</span>
        <span class="q-badge badge-teal" id="q-domain-badge">PMET</span>
        <span class="q-badge badge-teal" id="q-type-badge">Definition</span>
      </div>

      <div class="q-chapter" id="q-chapter"></div>
      <div class="q-section"  id="q-section"></div>

      <!-- Mode-specific question content injected here -->
      <div id="question-body"></div>

      <div class="kbd-hint" id="kbd-hint">
        <kbd>1</kbd> <kbd>2</kbd> <kbd>3</kbd> <kbd>4</kbd> to select &nbsp;&middot;&nbsp; <kbd>&crarr;</kbd> to continue
      </div>

      <div class="feedback-panel" id="feedback-panel">
        <div class="feedback-header"    id="feedback-header"></div>
        <div class="feedback-body"      id="feedback-body"></div>
        <div class="feedback-error-info" id="feedback-error-info"></div>
      </div>

      <button class="next-btn" id="next-btn" onclick="nextQuestion()">
        Next Question &rarr;
      </button>

    </div>

    <!-- Results -->
    <div id="screen-results">
      <div class="results-icon">&#128270;</div>
      <div class="results-title" id="results-title">Session Complete</div>
      <div class="results-sub"   id="results-sub"></div>

      <div class="score-ring-wrap">
        <div class="score-ring" id="score-ring">
          <div class="score-ring-inner">
            <div class="score-pct"  id="result-pct">&mdash;</div>
            <div class="score-frac" id="result-frac">&mdash; / &mdash;</div>
          </div>
        </div>
      </div>

      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-n"     id="stat-correct">&mdash;</div>
          <div class="stat-label">Correct</div>
        </div>
        <div class="stat-box">
          <div class="stat-n"     id="stat-wrong">&mdash;</div>
          <div class="stat-label">Incorrect</div>
        </div>
        <div class="stat-box">
          <div class="stat-n"     id="stat-total">&mdash;</div>
          <div class="stat-label">Total</div>
        </div>
      </div>

      <div class="results-btns">
        <button class="btn-primary" onclick="restartSession()">Try Again</button>
        <button class="btn-outline"  id="btn-review" onclick="showReview()" style="display:none">Review Missed</button>
        <a class="btn-outline" href="spot-settings.html">Change Settings</a>
        <a class="btn-outline" href="index.html">Home</a>
      </div>
    </div>

    <!-- Review Missed -->
    <div id="screen-review">
      <div class="review-header">
        <button class="btn-outline" onclick="closeReview()">&larr; Back to Results</button>
        <div class="review-title">Questions You Missed</div>
      </div>
      <div id="review-list"></div>
    </div>

  </div>

  <script src="data/spot_data.js"></script>
  <script>
    const params       = new URLSearchParams(location.search);
    const DOMAIN_CODES = (params.get('domains') || '').split(',').filter(Boolean);
    const COUNT        = parseInt(params.get('count') || '20', 10);
    const TYPE_FILTER  = params.get('type') || 'all';
    const MODE_FILTER  = params.get('mode') || 'all';

    const TYPE_LABELS = {
      paragraph:    'Paragraph',
      definition:   'Definition',
      clinical_note:'Clinical Note',
      example:      'Example',
    };

    const MODE_LABELS = {
      mc:            'Multiple Choice',
      passage_click: 'Click Sentence',
      sentence_click:'Click the Phrase',
      vocab:         'Vocab Drill',
    };

    let pool     = [];
    let current  = 0;
    let correct  = 0;
    let answered = false;
    let missed   = []; // { q, missedInfo }

    // ── Helpers ───────────────────────────────────────────────────────────────
    function escHtml(s) {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    function buildHighlightedPassage(text, errOrig) {
      if (!errOrig) return escHtml(text);
      let idx = text.indexOf(errOrig);
      let matched = errOrig;
      if (idx === -1) {
        const lower = text.toLowerCase();
        idx = lower.indexOf(errOrig.toLowerCase());
        if (idx !== -1) matched = text.slice(idx, idx + errOrig.length);
      }
      if (idx === -1) return escHtml(text);
      return escHtml(text.slice(0, idx)) +
        `<mark class="error-highlight">${escHtml(matched)}</mark>` +
        escHtml(text.slice(idx + matched.length));
    }

    function qMode(q) {
      return q.mode || 'mc';
    }

    // ── Load question data from bundled script tag ─────────────────────────────
    function loadData() {
      const spotData = window.__SPOT_DATA || {};
      const all      = [];
      const missing  = [];

      for (const code of DOMAIN_CODES) {
        const data = spotData[code];
        if (!data) {
          missing.push(code);
          console.warn(`${code} not found in window.__SPOT_DATA`);
          continue;
        }
        let qs = data.questions || [];
        const beforeFilter = qs.length;
        if (TYPE_FILTER !== 'all') {
          qs = qs.filter(q => q.passage_type === TYPE_FILTER);
        }
        if (MODE_FILTER !== 'all') {
          qs = qs.filter(q => qMode(q) === MODE_FILTER);
        }
        all.push(...qs);
        console.log(`${code}: ${beforeFilter} total → ${qs.length} after filter (type=${TYPE_FILTER}, mode=${MODE_FILTER})`);
      }

      if (all.length === 0) {
        const debugInfo = [
          `Domains: ${DOMAIN_CODES.join(', ') || '(none)'}`,
          `Mode filter: ${MODE_FILTER}`,
          `Type filter: ${TYPE_FILTER}`,
          missing.length ? `Not in bundle: ${missing.join(', ')}` : null,
        ].filter(Boolean).join(' | ');
        document.getElementById('screen-loading').innerHTML =
          `<div style="color:var(--red);font-size:14px;text-align:center;padding:20px;">
            No questions found for the selected domains and mode.<br>
            <small style="color:var(--text3);display:block;margin-top:8px;">${debugInfo}</small>
          </div>`;
        return;
      }

      // Fisher-Yates shuffle then trim to COUNT
      for (let i = all.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [all[i], all[j]] = [all[j], all[i]];
      }
      pool = all.slice(0, COUNT);
      showQuestion();
    }

    // ── Shared post-answer logic ──────────────────────────────────────────────
    function onAnswered(isCorrect, q, missedInfo) {
      answered = true;

      if (isCorrect) {
        correct++;
      } else {
        missed.push({ q, missedInfo });
      }

      const fp = document.getElementById('feedback-panel');
      fp.className = 'feedback-panel ' + (isCorrect ? 'correct' : 'wrong');
      fp.style.display = 'block';

      document.getElementById('feedback-header').innerHTML =
        isCorrect ? '&#10003; Correct!' : '&#10007; Not quite';
      document.getElementById('feedback-body').textContent = q.explanation;
      document.getElementById('feedback-error-info').innerHTML =
        `<strong>Error in question:</strong> &ldquo;${escHtml(q.error_original)}&rdquo;` +
        ` &nbsp;&rarr;&nbsp; ` +
        `<strong>Should be:</strong> &ldquo;${escHtml(q.error_correct)}&rdquo;`;

      document.getElementById('nav-score').textContent = `${correct} / ${current + 1}`;

      const nb = document.getElementById('next-btn');
      nb.style.display = 'block';
      nb.textContent   =
        current + 1 < pool.length ? 'Next Question \u2192' : 'See Results \u2192';

      setTimeout(() => {
        fp.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 120);
    }

    // ── Show question dispatcher ──────────────────────────────────────────────
    function showQuestion() {
      const q = pool[current];
      answered = false;

      // Progress
      document.getElementById('progress-fill').style.width =
        (current / pool.length * 100) + '%';

      // Nav
      document.getElementById('nav-score').textContent = `${correct} / ${current}`;
      document.getElementById('nav-meta').textContent  = `${pool.length - current} left`;

      // Q meta
      document.getElementById('q-num').textContent =
        `Question ${current + 1} of ${pool.length}`;
      document.getElementById('q-domain-badge').textContent = q.domain_code;
      const mode = qMode(q);
      const typeBadgeEl = document.getElementById('q-type-badge');
      if (mode === 'sentence_click') {
        typeBadgeEl.innerHTML =
          'Click the Phrase &nbsp;<span class="q-badge badge-teal" style="padding:2px 8px;">Find the Error</span>';
      } else {
        typeBadgeEl.textContent = MODE_LABELS[mode] || TYPE_LABELS[q.passage_type] || q.passage_type;
      }
      document.getElementById('q-chapter').textContent = q.chapter_title;
      document.getElementById('q-section').textContent  = q.section || '';

      // Reset feedback
      const fp = document.getElementById('feedback-panel');
      fp.style.display = 'none';
      fp.className = 'feedback-panel';
      document.getElementById('next-btn').style.display = 'none';

      // Render mode-specific content
      const body = document.getElementById('question-body');
      body.innerHTML = '';
      const mode = qMode(q);
      if      (mode === 'mc')             renderMC(q, body);
      else if (mode === 'passage_click')  renderPassageClick(q, body);
      else if (mode === 'sentence_click') renderSentenceClick(q, body);
      else if (mode === 'vocab')          renderVocab(q, body);

      // Show quiz screen
      document.getElementById('screen-loading').style.display = 'none';
      document.getElementById('screen-quiz').style.display    = 'block';
    }

    // ── Renderer: Multiple Choice ─────────────────────────────────────────────
    function renderMC(q, body) {
      // Passage card
      const card = document.createElement('div');
      card.className = 'passage-card';
      card.innerHTML = `
        <div class="passage-label">&#128270; Read carefully &mdash; one fact has been changed</div>
        <div class="passage-text" id="passage-text">${escHtml(q.modified_passage)}</div>
        <div class="passage-instruction">Select the option that correctly identifies the error.</div>
      `;
      body.appendChild(card);

      // Options
      const ol = document.createElement('div');
      ol.className = 'options-list';
      body.appendChild(ol);

      const indices = [0, 1, 2, 3];
      for (let i = 3; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [indices[i], indices[j]] = [indices[j], indices[i]];
      }
      const letters = ['A', 'B', 'C', 'D'];
      indices.forEach((origIdx, displayIdx) => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.dataset.origIdx = origIdx;
        btn.innerHTML = `
          <div class="opt-letter">${letters[displayIdx]}</div>
          <div class="opt-text">${escHtml(q.options[origIdx])}</div>
        `;
        btn.onclick = () => {
          if (answered) return;
          const isCorrect = origIdx === q.correct_option_index;
          ol.querySelectorAll('.option-btn').forEach(b => {
            b.disabled = true;
            const bi = parseInt(b.dataset.origIdx);
            if (bi === q.correct_option_index) {
              b.classList.add(bi === origIdx ? 'correct' : 'reveal');
            }
          });
          if (isCorrect) btn.classList.add('correct');
          else           btn.classList.add('wrong');
          // Highlight error in passage
          document.getElementById('passage-text').innerHTML =
            buildHighlightedPassage(q.modified_passage, q.error_original);
          onAnswered(isCorrect, q, { type: 'mc', optionIdx: origIdx });
        };
        ol.appendChild(btn);
      });

      // Kbd hint
      document.getElementById('kbd-hint').innerHTML =
        '<kbd>1</kbd> <kbd>2</kbd> <kbd>3</kbd> <kbd>4</kbd> to select &nbsp;&middot;&nbsp; <kbd>&crarr;</kbd> to continue';
    }

    // ── Renderer: Click the Sentence ──────────────────────────────────────────
    function renderPassageClick(q, body) {
      const card = document.createElement('div');
      card.className = 'passage-card';
      card.innerHTML = `<div class="passage-label">&#128270; Click the sentence that contains the error</div>`;

      const sentencesDiv = document.createElement('div');
      sentencesDiv.className = 'passage-sentences';

      q.sentences.forEach((sentence, idx) => {
        const div = document.createElement('div');
        div.className = 'clickable-sentence';
        div.textContent = sentence;
        div.onclick = () => {
          if (answered) return;
          const isCorrect = idx === q.target_sentence_index;

          sentencesDiv.querySelectorAll('.clickable-sentence').forEach((el, i) => {
            el.style.pointerEvents = 'none';
            if (i === q.target_sentence_index) {
              el.classList.add('sentence-correct');
              el.innerHTML = buildHighlightedPassage(
                q.sentences[q.target_sentence_index], q.error_original);
            }
          });
          if (!isCorrect) div.classList.add('sentence-wrong');

          onAnswered(isCorrect, q, { type: 'passage_click', sentenceIdx: idx });
        };
        sentencesDiv.appendChild(div);
      });

      card.appendChild(sentencesDiv);
      body.appendChild(card);

      document.getElementById('kbd-hint').innerHTML =
        'Click a sentence &nbsp;&middot;&nbsp; <kbd>&crarr;</kbd> to continue';
    }

    // ── Renderer: Click the Phrase ────────────────────────────────────────────
    function renderSentenceClick(q, body) {
      const card = document.createElement('div');
      card.className = 'passage-card';
      card.innerHTML = `<div class="passage-label">&#128270; Click the word or phrase that contains the error</div>`;

      const sentenceDiv = document.createElement('div');
      sentenceDiv.className = 'phrase-container';

      q.phrases.forEach((phrase, idx) => {
        const span = document.createElement('span');
        span.className = 'clickable-phrase';
        span.textContent = phrase;
        span.onclick = () => {
          if (answered) return;
          const isCorrect = idx === q.target_phrase_index;

          sentenceDiv.querySelectorAll('.clickable-phrase').forEach((el, i) => {
            el.style.pointerEvents = 'none';
            if (i === q.target_phrase_index) {
              el.classList.add('phrase-correct');
              el.innerHTML = buildHighlightedPassage(
                q.phrases[q.target_phrase_index], q.error_original);
            }
          });
          if (!isCorrect) span.classList.add('phrase-wrong');

          onAnswered(isCorrect, q, { type: 'sentence_click', phraseIdx: idx });
        };
        sentenceDiv.appendChild(span);
      });

      card.appendChild(sentenceDiv);
      body.appendChild(card);

      document.getElementById('kbd-hint').innerHTML =
        'Click a phrase &nbsp;&middot;&nbsp; <kbd>&crarr;</kbd> to continue';
    }

    // ── Renderer: Vocab Drill ─────────────────────────────────────────────────
    function renderVocab(q, body) {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `<div class="passage-label" style="margin-bottom:14px;">&#128270; Click the card with the error in its definition</div>`;

      const grid = document.createElement('div');
      grid.className = 'vocab-grid';

      // Shuffle display order
      const displayOrder = [...q.entries.keys()];
      for (let i = displayOrder.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [displayOrder[i], displayOrder[j]] = [displayOrder[j], displayOrder[i]];
      }

      displayOrder.forEach(origIdx => {
        const entry = q.entries[origIdx];
        const card  = document.createElement('div');
        card.className = 'vocab-card';
        card.dataset.origIdx = origIdx;

        const termEl = document.createElement('div');
        termEl.className = 'vocab-term';
        termEl.textContent = entry.term;

        const defEl = document.createElement('div');
        defEl.className = 'vocab-def';
        defEl.textContent = entry.definition;

        card.appendChild(termEl);
        card.appendChild(defEl);

        card.onclick = () => {
          if (answered) return;
          const isCorrect = origIdx === q.target_entry_index;

          grid.querySelectorAll('.vocab-card').forEach(el => {
            el.style.pointerEvents = 'none';
            const oi = parseInt(el.dataset.origIdx);
            if (oi === q.target_entry_index) {
              el.classList.add('vocab-correct');
              el.querySelector('.vocab-def').innerHTML =
                buildHighlightedPassage(
                  q.entries[q.target_entry_index].definition, q.error_original);
            }
          });
          if (!isCorrect) card.classList.add('vocab-wrong');

          onAnswered(isCorrect, q, { type: 'vocab', entryIdx: origIdx });
        };
        grid.appendChild(card);
      });

      wrapper.appendChild(grid);
      body.appendChild(wrapper);

      document.getElementById('kbd-hint').innerHTML =
        'Click a card &nbsp;&middot;&nbsp; <kbd>&crarr;</kbd> to continue';
    }

    // ── Navigation ────────────────────────────────────────────────────────────
    function nextQuestion() {
      current++;
      if (current >= pool.length) {
        showResults();
      } else {
        const qs = document.getElementById('screen-quiz');
        qs.style.display = 'none';
        qs.style.animation = 'none';
        showQuestion();
        void qs.offsetWidth; // reflow to restart animation
        qs.style.animation = '';
      }
    }

    function showResults() {
      document.getElementById('screen-quiz').style.display = 'none';
      const pct = Math.round((correct / pool.length) * 100);

      document.getElementById('progress-fill').style.width   = '100%';
      document.getElementById('nav-score').textContent       = `${correct} / ${pool.length}`;
      document.getElementById('nav-meta').textContent        = 'Complete';

      document.getElementById('result-pct').textContent  = pct + '%';
      document.getElementById('result-frac').textContent = `${correct} / ${pool.length}`;
      document.getElementById('stat-correct').textContent = correct;
      document.getElementById('stat-wrong').textContent   = pool.length - correct;
      document.getElementById('stat-total').textContent   = pool.length;

      const title = pct >= 90 ? 'Outstanding!' :
                    pct >= 75 ? 'Great Work!'   :
                    pct >= 60 ? 'Good Effort'   : 'Keep Practicing';
      document.getElementById('results-title').textContent = title;
      document.getElementById('results-sub').textContent   =
        `You caught ${correct} out of ${pool.length} errors.`;

      document.getElementById('score-ring').style.setProperty('--pct', pct + '%');

      if (missed.length > 0) {
        const rb = document.getElementById('btn-review');
        rb.textContent   = `Review Missed (${missed.length})`;
        rb.style.display = 'inline-block';
      }

      document.getElementById('screen-results').style.display = 'flex';
    }

    function restartSession() {
      current = 0; correct = 0; answered = false;
      missed = [];
      document.getElementById('btn-review').style.display = 'none';
      for (let i = pool.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [pool[i], pool[j]] = [pool[j], pool[i]];
      }
      document.getElementById('screen-results').style.display = 'none';
      document.getElementById('progress-fill').style.width    = '0%';
      showQuestion();
    }

    // ── Review Missed ─────────────────────────────────────────────────────────
    function buildReviewContent(q, missedInfo) {
      const mode = qMode(q);

      if (mode === 'mc') {
        const passageHtml = buildHighlightedPassage(q.modified_passage || '', q.error_original || '');
        const chosenText  = escHtml(q.options[missedInfo.optionIdx] || '');
        const correctText = escHtml(q.options[q.correct_option_index] || '');
        return `
          <div class="review-passage">${passageHtml}</div>
          <div class="review-answer-row">
            <div class="review-choice wrong">&#10007; You chose: ${chosenText}</div>
            <div class="review-choice correct">&#10003; Correct: ${correctText}</div>
          </div>`;
      }

      if (mode === 'passage_click') {
        const sentencesHtml = q.sentences.map((s, i) => {
          const cls     = i === q.target_sentence_index ? 'sentence-correct' : '';
          const content = i === q.target_sentence_index
            ? buildHighlightedPassage(s, q.error_original) : escHtml(s);
          return `<div class="review-sentence ${cls}">${content}</div>`;
        }).join('');
        const chosenSentence  = escHtml(q.sentences[missedInfo.sentenceIdx] || '');
        const correctSentence = escHtml(q.sentences[q.target_sentence_index] || '');
        return `
          <div class="review-sentences">${sentencesHtml}</div>
          <div class="review-answer-row">
            <div class="review-choice wrong">&#10007; You clicked: &ldquo;${chosenSentence}&rdquo;</div>
            <div class="review-choice correct">&#10003; Error was in: &ldquo;${correctSentence}&rdquo;</div>
          </div>`;
      }

      if (mode === 'sentence_click') {
        const phrasesHtml = q.phrases.map((p, i) => {
          const cls     = i === q.target_phrase_index ? 'phrase-correct' : '';
          const content = i === q.target_phrase_index
            ? buildHighlightedPassage(p, q.error_original) : escHtml(p);
          return `<span class="clickable-phrase ${cls}" style="pointer-events:none;">${content}</span>`;
        }).join('');
        const chosenPhrase  = escHtml(q.phrases[missedInfo.phraseIdx] || '');
        const correctPhrase = escHtml(q.phrases[q.target_phrase_index] || '');
        return `
          <div class="review-passage"><span class="phrase-container">${phrasesHtml}</span></div>
          <div class="review-answer-row">
            <div class="review-choice wrong">&#10007; You clicked: &ldquo;${chosenPhrase}&rdquo;</div>
            <div class="review-choice correct">&#10003; Error was in: &ldquo;${correctPhrase}&rdquo;</div>
          </div>`;
      }

      if (mode === 'vocab') {
        const cardsHtml = q.entries.map((e, i) => {
          const cls    = i === q.target_entry_index ? 'vocab-correct' : '';
          const defHtml = i === q.target_entry_index
            ? buildHighlightedPassage(e.definition, q.error_original) : escHtml(e.definition);
          return `
            <div class="vocab-card ${cls}" style="pointer-events:none;">
              <div class="vocab-term">${escHtml(e.term)}</div>
              <div class="vocab-def">${defHtml}</div>
            </div>`;
        }).join('');
        const chosenTerm  = escHtml((q.entries[missedInfo.entryIdx] || {}).term || '');
        const correctTerm = escHtml((q.entries[q.target_entry_index] || {}).term || '');
        return `
          <div class="review-vocab-grid">${cardsHtml}</div>
          <div class="review-answer-row">
            <div class="review-choice wrong">&#10007; You clicked: ${chosenTerm}</div>
            <div class="review-choice correct">&#10003; Error was in: ${correctTerm}</div>
          </div>`;
      }

      return '';
    }

    function showReview() {
      document.getElementById('screen-results').style.display = 'none';
      const list = document.getElementById('review-list');
      list.innerHTML = '';

      missed.forEach(({ q, missedInfo }, i) => {
        const card = document.createElement('div');
        card.className = 'review-card';
        card.style.animationDelay = (i * 0.05) + 's';

        const chapterLine = escHtml(q.chapter_title) +
          (q.section ? ' &middot; ' + escHtml(q.section) : '');
        const modeBadge   = MODE_LABELS[qMode(q)] || 'MC';

        card.innerHTML = `
          <div class="review-card-meta">
            <span class="q-badge badge-teal">${escHtml(q.domain_code)}</span>
            <span class="q-badge badge-teal">${escHtml(modeBadge)}</span>
            <span class="review-card-chapter">${chapterLine}</span>
          </div>
          ${buildReviewContent(q, missedInfo)}
          <div class="review-explanation">
            ${escHtml(q.explanation)}
            <div class="review-error-line">
              <strong>Error:</strong>
              &ldquo;${escHtml(q.error_original)}&rdquo;
              &rarr;
              &ldquo;${escHtml(q.error_correct)}&rdquo;
            </div>
          </div>
        `;
        list.appendChild(card);
      });

      document.getElementById('screen-review').style.display = 'block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function closeReview() {
      document.getElementById('screen-review').style.display  = 'none';
      document.getElementById('screen-results').style.display = 'flex';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ── Keyboard shortcuts ────────────────────────────────────────────────────
    document.addEventListener('keydown', e => {
      const q    = pool[current];
      const mode = q ? qMode(q) : 'mc';

      // 1–4: select option (MC only, before answering)
      if (['1', '2', '3', '4'].includes(e.key) && !answered && mode === 'mc') {
        const btns = document.querySelectorAll('.option-btn:not(:disabled)');
        const idx  = parseInt(e.key) - 1;
        if (btns[idx]) btns[idx].click();
        return;
      }
      // Enter or → : advance (after answering)
      if ((e.key === 'Enter' || e.key === 'ArrowRight') && answered) {
        const nb = document.getElementById('next-btn');
        if (nb && nb.style.display !== 'none') nb.click();
      }
    });

    loadData();
  </script>
</body>
</html>
