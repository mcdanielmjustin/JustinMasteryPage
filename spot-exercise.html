<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spot the Error | MasteryPage</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #09090b;
      --bg2: #0f0f11;
      --bg3: #18181b;
      --card: #1c1c1f;
      --teal: #2dd4bf;
      --teal-light: #5eead4;
      --teal-dark: #0d9488;
      --text: #fafafa;
      --text2: #a8a8b3;
      --text3: #6b6b76;
      --border: rgba(255,255,255,0.07);
      --green: #34d399;
      --red: #f87171;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, sans-serif;
      min-height: 100vh;
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(16px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes correctPulse {
      0%   { box-shadow: 0 0 0 0 rgba(52,211,153,0.5); }
      60%  { box-shadow: 0 0 0 10px rgba(52,211,153,0); }
      100% { box-shadow: none; }
    }
    @keyframes wrongShake {
      0%,100% { transform: translateX(0); }
      20%     { transform: translateX(-6px); }
      40%     { transform: translateX(6px); }
      60%     { transform: translateX(-4px); }
      80%     { transform: translateX(4px); }
    }
    @keyframes progressGlow {
      0%,100% { opacity: 0.7; }
      50%     { opacity: 1; }
    }

    /* NAV */
    nav {
      position: fixed; top:0; left:0; right:0; z-index:10; height:60px;
      background: rgba(9,9,11,0.9); backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; padding: 0 24px; gap: 16px;
    }
    .logo { display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit; }
    .logo-icon {
      width:32px; height:32px; border-radius:8px;
      background: linear-gradient(135deg,#9333ea,#6d28d9);
      display:flex; align-items:center; justify-content:center;
      font-weight:700; font-size:15px; color:#fff;
    }
    .logo-title { font-weight:700; font-size:14px; }
    .nav-spacer { flex: 1; }
    .nav-meta { font-size: 12px; color: var(--text3); text-align: right; }
    .nav-score { font-weight: 600; color: var(--teal-light); font-size: 14px; }

    /* MAIN LAYOUT */
    .page {
      padding-top: 60px;
      min-height: 100vh;
      display: flex; flex-direction: column; align-items: center;
    }

    /* PROGRESS BAR */
    .progress-wrap {
      width: 100%; height: 3px;
      background: rgba(255,255,255,0.06);
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--teal-dark), var(--teal-light));
      transition: width 0.4s ease;
    }

    /* LOADING */
    #screen-loading {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; gap: 16px;
      padding: 80px 24px; width: 100%;
    }
    .loading-text { font-size: 14px; color: var(--text2); }
    .spinner {
      width: 32px; height: 32px;
      border: 2px solid var(--border);
      border-top-color: var(--teal);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* QUIZ SCREEN */
    #screen-quiz {
      display: none;
      width: 100%; max-width: 780px;
      padding: 32px 24px 80px;
      animation: fadeInUp 0.4s ease-out both;
    }

    .q-meta {
      display: flex; align-items: center; gap: 10px;
      margin-bottom: 20px; flex-wrap: wrap;
    }
    .q-num {
      font-size: 11px; font-weight: 600; letter-spacing: 0.08em;
      color: var(--text3); text-transform: uppercase;
    }
    .q-badge {
      font-size: 10px; font-weight: 600; letter-spacing: 0.08em;
      text-transform: uppercase; padding: 3px 10px;
      border-radius: 20px; border: 1px solid;
    }
    .badge-teal { color: var(--teal-light); border-color: rgba(45,212,191,0.35); background: rgba(45,212,191,0.08); }

    .q-chapter {
      font-size: 12px; color: var(--text3);
      margin-bottom: 6px;
    }
    .q-section {
      font-size: 11px; color: var(--text3);
      margin-bottom: 20px;
    }

    /* Passage */
    .passage-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px 26px;
      margin-bottom: 24px;
      position: relative;
    }
    .passage-label {
      font-size: 10px; font-weight: 600; letter-spacing: 0.1em;
      text-transform: uppercase; color: var(--teal);
      margin-bottom: 14px;
    }
    .passage-text {
      font-size: 15px;
      line-height: 1.75;
      color: var(--text2);
    }
    .passage-instruction {
      font-size: 12px; color: var(--text3);
      margin-top: 14px;
      font-style: italic;
    }

    /* Options */
    .options-list {
      display: flex; flex-direction: column; gap: 10px;
      margin-bottom: 20px;
    }
    .option-btn {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 18px;
      text-align: left;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      display: flex; align-items: flex-start; gap: 12px;
    }
    .option-btn:hover:not(:disabled) {
      border-color: rgba(45,212,191,0.4);
      background: rgba(45,212,191,0.06);
    }
    .option-btn:disabled { cursor: default; }
    .opt-letter {
      width: 24px; height: 24px; border-radius: 6px;
      background: var(--bg3);
      display: flex; align-items: center; justify-content: center;
      font-size: 11px; font-weight: 700; color: var(--text3);
      flex-shrink: 0; margin-top: 1px;
    }
    .opt-text { font-size: 13px; color: var(--text2); line-height: 1.5; }

    /* Feedback states */
    .option-btn.correct {
      border-color: var(--green);
      background: rgba(52,211,153,0.08);
      animation: correctPulse 0.6s ease-out;
    }
    .option-btn.correct .opt-letter { background: rgba(52,211,153,0.2); color: var(--green); }
    .option-btn.correct .opt-text { color: var(--text); }

    .option-btn.wrong {
      border-color: var(--red);
      background: rgba(248,113,113,0.08);
      animation: wrongShake 0.4s ease-out;
    }
    .option-btn.wrong .opt-letter { background: rgba(248,113,113,0.2); color: var(--red); }

    .option-btn.reveal {
      border-color: rgba(52,211,153,0.4);
      background: rgba(52,211,153,0.05);
    }
    .option-btn.reveal .opt-letter { background: rgba(52,211,153,0.15); color: var(--green); }

    /* Feedback panel */
    .feedback-panel {
      display: none;
      border-radius: 14px;
      padding: 18px 20px;
      margin-bottom: 20px;
      animation: fadeIn 0.3s ease-out both;
    }
    .feedback-panel.correct { background: rgba(52,211,153,0.08); border: 1px solid rgba(52,211,153,0.3); }
    .feedback-panel.wrong   { background: rgba(248,113,113,0.08); border: 1px solid rgba(248,113,113,0.3); }
    .feedback-header {
      font-size: 13px; font-weight: 700; margin-bottom: 8px;
    }
    .feedback-panel.correct .feedback-header { color: var(--green); }
    .feedback-panel.wrong   .feedback-header { color: var(--red); }
    .feedback-body { font-size: 13px; color: var(--text2); line-height: 1.6; }
    .feedback-error-info {
      margin-top: 12px; padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.07);
      font-size: 12px; color: var(--text3);
    }
    .feedback-error-info strong { color: var(--text2); }

    .next-btn {
      width: 100%;
      background: linear-gradient(135deg, var(--teal-dark), #0f766e);
      border: none; border-radius: 12px;
      padding: 14px;
      font-size: 14px; font-weight: 700; color: #fff;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.15s;
      display: none;
    }
    .next-btn:hover { opacity: 0.9; transform: translateY(-1px); }

    /* RESULTS SCREEN */
    #screen-results {
      display: none;
      flex-direction: column; align-items: center;
      padding: 60px 24px;
      animation: fadeInUp 0.5s ease-out both;
    }
    .results-icon { font-size: 56px; margin-bottom: 20px; }
    .results-title {
      font-family: 'Instrument Serif', Georgia, serif;
      font-size: 2.4rem;
      margin-bottom: 8px;
      text-align: center;
    }
    .results-sub { font-size: 15px; color: var(--text2); margin-bottom: 32px; text-align: center; }

    .score-ring-wrap { margin-bottom: 36px; }
    .score-ring {
      width: 140px; height: 140px;
      border-radius: 50%;
      background: conic-gradient(var(--teal) var(--pct), rgba(255,255,255,0.07) 0);
      display: flex; align-items: center; justify-content: center;
      position: relative;
    }
    .score-ring-inner {
      width: 108px; height: 108px;
      border-radius: 50%;
      background: var(--bg);
      display: flex; align-items: center; justify-content: center;
      flex-direction: column; gap: 2px;
    }
    .score-pct { font-size: 1.8rem; font-weight: 700; color: var(--teal-light); }
    .score-frac { font-size: 11px; color: var(--text3); }

    .stats-row {
      display: flex; gap: 24px; margin-bottom: 36px;
      flex-wrap: wrap; justify-content: center;
    }
    .stat-box {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px 24px;
      text-align: center;
      min-width: 100px;
    }
    .stat-n { font-size: 1.6rem; font-weight: 700; color: var(--teal-light); }
    .stat-label { font-size: 11px; color: var(--text3); margin-top: 4px; }

    .results-btns { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; }
    .btn-outline {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 12px; padding: 12px 24px;
      font-size: 13px; font-weight: 600; color: var(--text2);
      cursor: pointer; transition: border-color 0.2s, color 0.2s;
      text-decoration: none; display: inline-block;
    }
    .btn-outline:hover { border-color: var(--teal); color: var(--teal-light); }
    .btn-primary {
      background: linear-gradient(135deg, var(--teal-dark), #0f766e);
      border: none; border-radius: 12px; padding: 12px 24px;
      font-size: 13px; font-weight: 700; color: #fff;
      cursor: pointer; transition: opacity 0.2s;
    }
    .btn-primary:hover { opacity: 0.9; }
  </style>
</head>
<body>

  <nav>
    <a class="logo" href="index.html">
      <div class="logo-icon">M</div>
      <span class="logo-title">MasteryPage</span>
    </a>
    <div class="nav-spacer"></div>
    <div>
      <div class="nav-score" id="nav-score">0 / 0</div>
      <div class="nav-meta" id="nav-meta">Loading...</div>
    </div>
  </nav>

  <div class="page">

    <div class="progress-wrap">
      <div class="progress-fill" id="progress-fill" style="width:0%"></div>
    </div>

    <!-- Loading -->
    <div id="screen-loading">
      <div class="spinner"></div>
      <div class="loading-text">Loading questions&hellip;</div>
    </div>

    <!-- Quiz -->
    <div id="screen-quiz">

      <div class="q-meta">
        <span class="q-num" id="q-num">Question 1 of 20</span>
        <span class="q-badge badge-teal" id="q-domain-badge">PMET</span>
        <span class="q-badge badge-teal" id="q-type-badge">Definition</span>
      </div>

      <div class="q-chapter" id="q-chapter"></div>
      <div class="q-section" id="q-section"></div>

      <div class="passage-card">
        <div class="passage-label">&#128270; Read carefully — one fact has been changed</div>
        <div class="passage-text" id="passage-text"></div>
        <div class="passage-instruction">Select the option that correctly identifies the error.</div>
      </div>

      <div class="options-list" id="options-list"></div>

      <div class="feedback-panel" id="feedback-panel">
        <div class="feedback-header" id="feedback-header"></div>
        <div class="feedback-body" id="feedback-body"></div>
        <div class="feedback-error-info" id="feedback-error-info"></div>
      </div>

      <button class="next-btn" id="next-btn" onclick="nextQuestion()">Next Question &rarr;</button>

    </div>

    <!-- Results -->
    <div id="screen-results">
      <div class="results-icon">&#128270;</div>
      <div class="results-title" id="results-title">Session Complete</div>
      <div class="results-sub" id="results-sub"></div>

      <div class="score-ring-wrap">
        <div class="score-ring" id="score-ring">
          <div class="score-ring-inner">
            <div class="score-pct" id="result-pct">—</div>
            <div class="score-frac" id="result-frac">— / —</div>
          </div>
        </div>
      </div>

      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-n" id="stat-correct">—</div>
          <div class="stat-label">Correct</div>
        </div>
        <div class="stat-box">
          <div class="stat-n" id="stat-wrong">—</div>
          <div class="stat-label">Incorrect</div>
        </div>
        <div class="stat-box">
          <div class="stat-n" id="stat-total">—</div>
          <div class="stat-label">Total</div>
        </div>
      </div>

      <div class="results-btns">
        <button class="btn-primary" onclick="restartSession()">Try Again</button>
        <a class="btn-outline" href="spot-settings.html">Change Settings</a>
        <a class="btn-outline" href="index.html">Home</a>
      </div>
    </div>

  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const DOMAIN_CODES = (params.get('domains') || '').split(',').filter(Boolean);
    const COUNT        = parseInt(params.get('count') || '20', 10);
    const TYPE_FILTER  = params.get('type') || 'all';

    const TYPE_LABELS = {
      paragraph:    'Paragraph',
      definition:   'Definition',
      clinical_note:'Clinical Note',
      example:      'Example',
    };

    let pool = [];
    let current = 0;
    let correct = 0;
    let answered = false;

    // ── Load question files ───────────────────────────────────────────────
    async function loadData() {
      const all = [];
      for (const code of DOMAIN_CODES) {
        try {
          const res = await fetch(`data/${code}_spot.json`);
          if (!res.ok) throw new Error(res.status);
          const data = await res.json();
          let qs = data.questions || [];
          if (TYPE_FILTER !== 'all') {
            qs = qs.filter(q => q.passage_type === TYPE_FILTER);
          }
          all.push(...qs);
        } catch (e) {
          console.warn(`Could not load ${code}_spot.json:`, e.message);
        }
      }

      if (all.length === 0) {
        document.getElementById('screen-loading').innerHTML =
          `<div style="color:var(--red);font-size:14px;text-align:center;padding:20px;">
            No questions found for the selected domains.<br>
            <small style="color:var(--text3)">Run generate_spot_errors.py to create questions.</small>
          </div>`;
        return;
      }

      // Fisher-Yates shuffle then trim to COUNT
      for (let i = all.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [all[i], all[j]] = [all[j], all[i]];
      }
      pool = all.slice(0, COUNT);

      showQuestion();
    }

    // ── Render a question ─────────────────────────────────────────────────
    function showQuestion() {
      const q = pool[current];
      answered = false;

      // Progress
      const pct = (current / pool.length) * 100;
      document.getElementById('progress-fill').style.width = pct + '%';

      // Nav
      document.getElementById('nav-score').textContent = `${correct} / ${current}`;
      document.getElementById('nav-meta').textContent =
        `${pool.length - current} left`;

      // Q meta
      document.getElementById('q-num').textContent =
        `Question ${current + 1} of ${pool.length}`;
      document.getElementById('q-domain-badge').textContent = q.domain_code;
      document.getElementById('q-type-badge').textContent =
        TYPE_LABELS[q.passage_type] || q.passage_type;

      document.getElementById('q-chapter').textContent = q.chapter_title;
      document.getElementById('q-section').textContent = q.section || '';

      // Passage
      document.getElementById('passage-text').textContent = q.modified_passage;

      // Options — shuffle display order but track correct index
      const indices = [0, 1, 2, 3];
      const letters = ['A', 'B', 'C', 'D'];
      const ol = document.getElementById('options-list');
      ol.innerHTML = '';
      indices.forEach((origIdx, displayIdx) => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.dataset.origIdx = origIdx;
        btn.innerHTML = `
          <div class="opt-letter">${letters[displayIdx]}</div>
          <div class="opt-text">${q.options[origIdx]}</div>
        `;
        btn.onclick = () => selectOption(btn, origIdx, q);
        ol.appendChild(btn);
      });

      // Reset feedback
      const fp = document.getElementById('feedback-panel');
      fp.style.display = 'none';
      fp.className = 'feedback-panel';

      document.getElementById('next-btn').style.display = 'none';

      // Show quiz screen
      document.getElementById('screen-loading').style.display = 'none';
      document.getElementById('screen-quiz').style.display = 'block';
    }

    function selectOption(btn, origIdx, q) {
      if (answered) return;
      answered = true;

      const isCorrect = origIdx === q.correct_option_index;
      const allBtns = document.querySelectorAll('.option-btn');
      allBtns.forEach(b => {
        b.disabled = true;
        if (parseInt(b.dataset.origIdx) === q.correct_option_index) {
          b.classList.add(parseInt(b.dataset.origIdx) === origIdx ? 'correct' : 'reveal');
        }
      });

      if (isCorrect) {
        btn.classList.add('correct');
        correct++;
      } else {
        btn.classList.add('wrong');
      }

      // Feedback panel
      const fp = document.getElementById('feedback-panel');
      fp.className = 'feedback-panel ' + (isCorrect ? 'correct' : 'wrong');
      fp.style.display = 'block';

      document.getElementById('feedback-header').textContent =
        isCorrect ? '&#10003; Correct!' : '&#10007; Not quite';
      document.getElementById('feedback-body').textContent = q.explanation;
      document.getElementById('feedback-error-info').innerHTML =
        `<strong>Error in passage:</strong> "${q.error_original}" &nbsp;&rarr;&nbsp; ` +
        `<strong>Should be:</strong> "${q.error_correct}"`;

      document.getElementById('nav-score').textContent = `${correct} / ${current + 1}`;

      document.getElementById('next-btn').style.display = 'block';
      document.getElementById('next-btn').textContent =
        current + 1 < pool.length ? 'Next Question \u2192' : 'See Results \u2192';
    }

    function nextQuestion() {
      current++;
      if (current >= pool.length) {
        showResults();
      } else {
        document.getElementById('screen-quiz').style.display = 'none';
        document.getElementById('screen-quiz').style.animation = 'none';
        showQuestion();
        void document.getElementById('screen-quiz').offsetWidth;
        document.getElementById('screen-quiz').style.animation = '';
      }
    }

    function showResults() {
      document.getElementById('screen-quiz').style.display = 'none';
      const pct = Math.round((correct / pool.length) * 100);

      document.getElementById('progress-fill').style.width = '100%';
      document.getElementById('nav-score').textContent = `${correct} / ${pool.length}`;
      document.getElementById('nav-meta').textContent = 'Complete';

      document.getElementById('result-pct').textContent = pct + '%';
      document.getElementById('result-frac').textContent = `${correct} / ${pool.length}`;
      document.getElementById('stat-correct').textContent = correct;
      document.getElementById('stat-wrong').textContent = pool.length - correct;
      document.getElementById('stat-total').textContent = pool.length;

      const title = pct >= 90 ? 'Outstanding!' :
                    pct >= 75 ? 'Great Work!' :
                    pct >= 60 ? 'Good Effort' : 'Keep Practicing';
      document.getElementById('results-title').textContent = title;
      document.getElementById('results-sub').textContent =
        `You caught ${correct} out of ${pool.length} errors.`;

      // Score ring
      document.getElementById('score-ring').style.setProperty('--pct', pct + '%');

      const rs = document.getElementById('screen-results');
      rs.style.display = 'flex';
    }

    function restartSession() {
      current = 0; correct = 0; answered = false;
      // Re-shuffle pool
      for (let i = pool.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [pool[i], pool[j]] = [pool[j], pool[i]];
      }
      document.getElementById('screen-results').style.display = 'none';
      document.getElementById('progress-fill').style.width = '0%';
      showQuestion();
    }

    loadData();
  </script>
</body>
</html>
