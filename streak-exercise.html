<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Streak Challenge â€” Mastery Page</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #09090b;
      --bg2: #111113;
      --orange: #f97316;
      --orange-light: #fb923c;
      --orange-dark: #c2580a;
      --green: #34d399;
      --red: #f87171;
      --text: #fafafa;
      --text2: #a8a8b3;
      --text3: #6b6b76;
      --border: rgba(255,255,255,0.07);
      --border-orange: rgba(249,115,22,0.25);
    }

    html, body { height: 100%; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, sans-serif;
      font-size: 15px;
      line-height: 1.6;
      overflow-x: hidden;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(14px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50%       { transform: scale(1.08); }
    }
    @keyframes shakeX {
      0%, 100% { transform: translateX(0); }
      20%       { transform: translateX(-8px); }
      40%       { transform: translateX(8px); }
      60%       { transform: translateX(-5px); }
      80%       { transform: translateX(5px); }
    }
    @keyframes streakBump {
      0%   { transform: scale(1); }
      40%  { transform: scale(1.25); }
      100% { transform: scale(1); }
    }
    @keyframes heartLost {
      0%   { transform: scale(1); }
      25%  { transform: scale(1.4) rotate(-10deg); }
      60%  { transform: scale(0.7) rotate(10deg); }
      100% { transform: scale(1); opacity: 0.2; }
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulseGlow {
      0%, 100% { opacity: 0.07; }
      50%       { opacity: 0.14; }
    }

    .blob {
      position: fixed; border-radius: 50%;
      filter: blur(120px); pointer-events: none;
      animation: pulseGlow 7s ease-in-out infinite; z-index: 0;
    }
    .blob-orange { width: 500px; height: 500px; background: #f97316; top: -200px; right: -150px; }
    .blob-purple { width: 380px; height: 380px; background: #9333ea; bottom: -120px; left: -100px; animation-delay: 3.5s; }

    /* â”€â”€ NAV â”€â”€ */
    nav {
      position: sticky; top: 0; z-index: 20;
      height: 56px;
      background: rgba(9,9,11,0.9);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center;
      padding: 0 24px; gap: 14px;
    }
    .back-btn {
      display: flex; align-items: center; gap: 6px;
      font-size: 13px; font-weight: 500;
      color: var(--text3); text-decoration: none;
      transition: color 0.2s;
    }
    .back-btn:hover { color: var(--orange); }
    .nav-sep { width: 1px; height: 18px; background: var(--border); }
    .nav-title { font-size: 13px; font-weight: 600; color: var(--text2); }
    .nav-streak {
      margin-left: auto;
      display: flex; align-items: center; gap: 8px;
      font-size: 13px; font-weight: 700;
    }
    .nav-streak-fire { font-size: 16px; }
    .nav-streak-count { font-family: 'Instrument Serif', serif; font-size: 1.2rem; color: var(--orange); }
    .nav-best {
      font-size: 11px; color: var(--text3);
      display: flex; align-items: center; gap: 4px;
    }

    /* â”€â”€ SCREENS â”€â”€ */
    .screen { display: none; }
    .screen.active { display: flex; flex-direction: column; }

    /* â”€â”€ LOADING â”€â”€ */
    #screen-loading {
      display: none;
    }
    #screen-loading.active {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - 56px);
      gap: 18px;
      padding: 40px 24px;
    }
    .loading-label { font-size: 14px; color: var(--text3); }
    .loading-bar-wrap {
      width: 260px; height: 4px;
      background: rgba(255,255,255,0.06); border-radius: 4px; overflow: hidden;
    }
    .loading-bar-fill {
      height: 100%; width: 0%;
      background: var(--orange);
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    #loading-text { font-size: 12px; color: var(--text3); }

    /* â”€â”€ QUIZ SCREEN â”€â”€ */
    #screen-quiz {
      min-height: calc(100vh - 56px);
      position: relative; z-index: 1;
      padding: 32px 24px 60px;
      max-width: 780px; margin: 0 auto; width: 100%;
    }

    /* Lives display */
    .lives-display {
      display: flex; justify-content: center; gap: 10px;
      margin-bottom: 20px;
    }
    .heart {
      font-size: 28px; line-height: 1;
      transition: opacity 0.3s;
      display: inline-block;
    }
    .heart.lost {
      opacity: 0.18;
      filter: grayscale(1);
      animation: heartLost 0.45s ease-out forwards;
    }

    /* Streak counter */
    .streak-display {
      display: flex; align-items: center; justify-content: center;
      flex-direction: column; gap: 2px;
      margin-bottom: 32px;
      animation: fadeInUp 0.4s ease-out both;
    }
    .streak-number {
      font-family: 'Instrument Serif', Georgia, serif;
      font-size: clamp(3.5rem, 10vw, 5rem);
      line-height: 1;
      color: var(--orange);
    }
    .streak-number.bump { animation: streakBump 0.4s ease-out; }
    .streak-label { font-size: 12px; color: var(--text3); letter-spacing: 0.1em; text-transform: uppercase; }
    .streak-best { font-size: 11px; color: var(--text3); margin-top: 2px; }

    /* Q meta */
    .q-meta {
      display: flex; align-items: center; gap: 8px;
      margin-bottom: 16px; flex-wrap: wrap;
    }
    .q-badge {
      font-size: 10px; font-weight: 700; letter-spacing: 0.06em;
      padding: 3px 9px; border-radius: 20px;
    }
    .badge-domain {
      background: rgba(249,115,22,0.12);
      color: var(--orange-light);
      border: 1px solid rgba(249,115,22,0.25);
    }
    .badge-angle {
      background: rgba(255,255,255,0.06);
      color: var(--text3);
      border: 1px solid var(--border);
    }
    .badge-sub {
      background: rgba(255,255,255,0.04);
      color: var(--text3);
      border: 1px solid var(--border);
      font-weight: 500;
    }

    /* Question card */
    .q-card {
      background: rgba(255,255,255,0.025);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 28px 28px 24px;
      margin-bottom: 18px;
      animation: fadeInUp 0.4s ease-out both;
    }
    .q-text {
      font-size: 15px; line-height: 1.75;
      color: var(--text);
      margin-bottom: 0;
    }

    /* Options */
    .options-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .option {
      display: flex; align-items: flex-start; gap: 14px;
      background: rgba(255,255,255,0.025);
      border: 1px solid var(--border);
      border-radius: 12px; padding: 14px 18px;
      cursor: pointer; user-select: none;
      transition: border-color 0.2s, background 0.2s, transform 0.15s;
    }
    .option:hover:not(.locked) { background: rgba(255,255,255,0.045); transform: translateX(3px); border-color: rgba(249,115,22,0.3); }
    .option.locked { cursor: default; }
    .option.correct  { border-color: var(--green);  background: rgba(52,211,153,0.08); }
    .option.wrong    { border-color: var(--red);     background: rgba(248,113,113,0.08); animation: shakeX 0.4s ease; }
    .option.dimmed   { opacity: 0.35; }
    .opt-letter {
      width: 26px; height: 26px; flex-shrink: 0;
      border: 1.5px solid var(--border); border-radius: 7px;
      display: flex; align-items: center; justify-content: center;
      font-size: 11px; font-weight: 700; color: var(--text3);
      transition: border-color 0.2s, background 0.2s, color 0.2s;
      margin-top: 1px;
    }
    .option.correct .opt-letter  { border-color: var(--green); background: rgba(52,211,153,0.15); color: var(--green); }
    .option.wrong   .opt-letter  { border-color: var(--red);   background: rgba(248,113,113,0.15); color: var(--red);   }
    .opt-text { font-size: 14px; line-height: 1.55; color: var(--text2); }
    .option.correct .opt-text, .option.wrong .opt-text { color: var(--text); }

    /* Feedback bar */
    .feedback-bar {
      display: none; align-items: center; gap: 12px;
      padding: 14px 20px; border-radius: 12px; margin-bottom: 16px;
      font-size: 14px; font-weight: 600;
    }
    .feedback-bar.correct { display: flex; background: rgba(52,211,153,0.1); border: 1px solid rgba(52,211,153,0.25); color: var(--green); }
    .feedback-bar.wrong   { display: flex; background: rgba(248,113,113,0.1); border: 1px solid rgba(248,113,113,0.25); color: var(--red); }
    .feedback-icon { font-size: 18px; }
    .feedback-sub { font-size: 12px; font-weight: 400; color: var(--text2); margin-top: 1px; }

    /* Next button */
    .next-btn {
      width: 100%; padding: 14px;
      background: rgba(249,115,22,0.15);
      border: 1px solid var(--border-orange);
      border-radius: 12px;
      color: var(--orange-light); font-family: inherit;
      font-size: 15px; font-weight: 600;
      cursor: pointer; display: none;
      align-items: center; justify-content: center; gap: 8px;
      transition: background 0.2s, border-color 0.2s;
    }
    .next-btn:hover { background: rgba(249,115,22,0.25); border-color: rgba(249,115,22,0.5); }
    .next-btn.visible { display: flex; animation: slideUp 0.25s ease-out both; }

    /* â”€â”€ GAME OVER SCREEN â”€â”€ */
    #screen-gameover {
      min-height: calc(100vh - 56px);
      align-items: center; justify-content: center;
      flex-direction: column;
      gap: 0;
      padding: 40px 24px;
      text-align: center;
      position: relative; z-index: 1;
    }

    .gameover-icon { font-size: 56px; margin-bottom: 16px; }

    .gameover-streak {
      font-family: 'Instrument Serif', Georgia, serif;
      font-size: clamp(5rem, 18vw, 9rem);
      line-height: 1;
      color: var(--orange);
      margin-bottom: 4px;
    }
    .gameover-streak-label {
      font-size: 13px; font-weight: 600; letter-spacing: 0.12em;
      text-transform: uppercase; color: var(--text3);
      margin-bottom: 32px;
    }

    .gameover-stats {
      display: flex; gap: 32px; justify-content: center;
      margin-bottom: 48px; flex-wrap: wrap;
    }
    .stat-item { display: flex; flex-direction: column; gap: 4px; }
    .stat-val { font-family: 'Instrument Serif', serif; font-size: 2rem; color: var(--text); }
    .stat-label { font-size: 11px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.08em; }

    .gameover-wrong {
      max-width: 540px; width: 100%;
      background: rgba(248,113,113,0.07);
      border: 1px solid rgba(248,113,113,0.2);
      border-radius: 16px;
      padding: 20px 24px;
      text-align: left;
      margin-bottom: 36px;
    }
    .gameover-wrong-label {
      font-size: 10px; font-weight: 700; letter-spacing: 0.1em;
      text-transform: uppercase; color: var(--red);
      margin-bottom: 10px;
    }
    .gameover-wrong-q { font-size: 14px; color: var(--text2); line-height: 1.55; margin-bottom: 10px; }
    .gameover-answer {
      font-size: 13px; color: var(--green);
      display: flex; align-items: flex-start; gap: 6px;
    }
    .gameover-answer-icon { font-size: 14px; flex-shrink: 0; margin-top: 2px; }

    .gameover-btns { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; }
    .btn-retry {
      padding: 14px 32px;
      background: linear-gradient(135deg, #fb923c, #f97316);
      color: #1a0800; font-family: inherit;
      font-size: 15px; font-weight: 700;
      border: none; border-radius: 12px; cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 20px rgba(249,115,22,0.3);
    }
    .btn-retry:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(249,115,22,0.4); }
    .btn-settings {
      padding: 14px 24px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 12px; color: var(--text2);
      font-family: inherit; font-size: 15px; font-weight: 500;
      cursor: pointer; text-decoration: none;
      display: flex; align-items: center; gap: 6px;
      transition: background 0.2s;
    }
    .btn-settings:hover { background: rgba(255,255,255,0.09); }

    /* Best streak badge on game over */
    .new-best {
      display: inline-flex; align-items: center; gap: 6px;
      background: rgba(249,115,22,0.12);
      border: 1px solid var(--border-orange);
      border-radius: 30px; padding: 5px 14px;
      font-size: 12px; font-weight: 600; color: var(--orange-light);
      margin-bottom: 16px;
    }
  </style>
</head>
<body>

  <div class="blob blob-orange"></div>
  <div class="blob blob-purple"></div>

  <nav>
    <a href="streak-settings.html" class="back-btn">&#8592; Settings</a>
    <div class="nav-sep"></div>
    <span class="nav-title">Streak Challenge</span>
    <div class="nav-streak" id="nav-streak-wrap" style="display:none">
      <span class="nav-streak-fire">&#128293;</span>
      <span class="nav-streak-count" id="nav-streak-count">0</span>
      <span class="nav-best" id="nav-best"></span>
    </div>
  </nav>

  <!-- LOADING -->
  <div id="screen-loading" class="active">
    <div class="loading-label">Loading questions&hellip;</div>
    <div class="loading-bar-wrap">
      <div class="loading-bar-fill" id="loading-progress-fill"></div>
    </div>
    <div id="loading-text"></div>
  </div>

  <!-- QUIZ -->
  <div id="screen-quiz" class="screen">
    <div class="lives-display" id="lives-display"></div>

    <div class="streak-display">
      <div class="streak-number" id="streak-number">0</div>
      <div class="streak-label">&#128293; Current Streak</div>
      <div class="streak-best" id="streak-best-inline"></div>
    </div>

    <div class="q-meta" id="q-meta"></div>

    <div class="q-card" id="q-card">
      <div class="q-text" id="q-text"></div>
    </div>

    <div class="options-list" id="options-list"></div>

    <div class="feedback-bar" id="feedback-bar">
      <span class="feedback-icon" id="feedback-icon"></span>
      <div>
        <div id="feedback-msg"></div>
        <div class="feedback-sub" id="feedback-sub"></div>
      </div>
    </div>

    <button class="next-btn" id="next-btn" onclick="nextQuestion()">Next Question &#8594;</button>
  </div>

  <!-- GAME OVER -->
  <div id="screen-gameover" class="screen">
    <div class="gameover-icon" id="gameover-icon">&#128293;</div>
    <div id="new-best-badge" style="display:none" class="new-best">&#127942; New Personal Best!</div>
    <div class="gameover-streak" id="gameover-streak">0</div>
    <div class="gameover-streak-label">Question Streak</div>

    <div class="gameover-stats">
      <div class="stat-item">
        <div class="stat-val" id="stat-best">0</div>
        <div class="stat-label">All-Time Best</div>
      </div>
      <div class="stat-item">
        <div class="stat-val" id="stat-domain">â€”</div>
        <div class="stat-label">Domain</div>
      </div>
    </div>

    <div class="gameover-wrong" id="gameover-wrong">
      <div class="gameover-wrong-label">&#10007; Question that ended your streak</div>
      <div class="gameover-wrong-q" id="gameover-wrong-q"></div>
      <div class="gameover-answer">
        <span class="gameover-answer-icon">&#10003;</span>
        <span id="gameover-answer-text"></span>
      </div>
    </div>

    <div class="gameover-btns">
      <button class="btn-retry" onclick="restartStreak()">&#128293; Go Again</button>
      <a href="streak-settings.html" class="btn-settings">&#9881; Change Settings</a>
    </div>
  </div>

  <script>
    // â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const DATA_BASE = 'data/';
    const ALL_DOMAINS = ['BPSY','CASS','CPAT','LDEV','PETH','PMET','PTHE','SOCU','WDEV'];
    const DOMAIN_NAMES = {
      BPSY: 'Biopsychology', CASS: 'Clinical Assessment', CPAT: 'Psychopathology',
      LDEV: 'Lifespan Dev.', PETH: 'Ethics', PMET: 'Psychometrics',
      PTHE: 'Psychotherapy', SOCU: 'Social/Cultural', WDEV: 'Workforce Dev.',
    };
    const ANGLE_LABELS = {
      direct_recall: 'Direct Recall', clinical_scenario: 'Clinical Scenario',
      contrast: 'Contrast', example_recognition: 'Example ID', implication: 'Implication',
    };

    const params  = new URLSearchParams(location.search);
    const domainParam = params.get('domains') || 'mixed';
    const MAX_LIVES   = parseInt(params.get('lives') || '1', 10);
    const SHUFFLE     = params.get('shuffle') !== 'off';

    const CFG_DOMAINS = domainParam === 'mixed' ? ALL_DOMAINS : domainParam.split(',');
    const STORAGE_KEY = 'streak_best_' + CFG_DOMAINS.slice().sort().join('_');

    // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let pool       = [];
    let streak     = 0;
    let peakStreak = 0;   // session high
    let bestStreak = parseInt(localStorage.getItem(STORAGE_KEY) || '0', 10);
    let livesLeft  = MAX_LIVES;
    let current    = null;
    let answered   = false;
    let gameOver   = false;
    let lastWrong  = null;

    // â”€â”€ Load questions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadQuestions() {
      const fill = document.getElementById('loading-progress-fill');
      const txt  = document.getElementById('loading-text');

      for (let i = 0; i < CFG_DOMAINS.length; i++) {
        const d = CFG_DOMAINS[i];
        txt.textContent = `Loading ${d}... (${i + 1}/${CFG_DOMAINS.length})`;
        fill.style.width = ((i / CFG_DOMAINS.length) * 100) + '%';
        try {
          const r = await fetch(`${DATA_BASE}${d}_basic.json`);
          if (r.ok) {
            const data = await r.json();
            pool = pool.concat(data.questions || []);
          }
        } catch (e) {}
      }

      fill.style.width = '100%';

      if (pool.length === 0) {
        document.getElementById('loading-text').textContent = 'No questions found. Check your settings.';
        return;
      }

      // Group questions by subdomain
      const subMap = new Map();
      for (const q of pool) {
        const key = (q.domain_code || '') + '||' + (q.subdomain || 'General');
        if (!subMap.has(key)) subMap.set(key, []);
        subMap.get(key).push(q);
      }
      let groups = [...subMap.values()];

      // Shuffle subdomain groups (not individual questions)
      if (SHUFFLE) {
        for (let i = groups.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [groups[i], groups[j]] = [groups[j], groups[i]];
        }
      }
      // Flatten and reverse so pop() yields first group first
      pool = groups.flat().reverse();

      renderLives();
      showScreen('quiz');
      updateNavStreak();
      document.getElementById('nav-streak-wrap').style.display = 'flex';
      nextQuestion();
    }

    // â”€â”€ Screen management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showScreen(name) {
      ['loading', 'quiz', 'gameover'].forEach(s => {
        const el = document.getElementById('screen-' + s);
        el.classList.remove('active');
      });
      document.getElementById('screen-' + name).classList.add('active');
    }

    // â”€â”€ Streak helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateNavStreak() {
      document.getElementById('nav-streak-count').textContent = streak;
      const bestEl = document.getElementById('nav-best');
      bestEl.textContent = bestStreak > 0 ? `Best: ${bestStreak}` : '';
    }

    function renderLives() {
      const wrap = document.getElementById('lives-display');
      wrap.innerHTML = '';
      for (let i = 0; i < MAX_LIVES; i++) {
        const span = document.createElement('span');
        span.className = 'heart' + (i >= livesLeft ? ' lost' : '');
        span.id = 'heart-' + i;
        span.textContent = '\u2764\uFE0F';
        wrap.appendChild(span);
      }
    }

    function loseLife() {
      livesLeft--;
      // Animate the heart that just got lost
      const heartEl = document.getElementById('heart-' + livesLeft);
      if (heartEl) {
        heartEl.classList.add('lost');
      }
    }

    function bumpStreakDisplay() {
      const el = document.getElementById('streak-number');
      el.textContent = streak;
      el.classList.remove('bump');
      void el.offsetWidth;
      el.classList.add('bump');
      if (streak > peakStreak) peakStreak = streak;
      const bestInline = document.getElementById('streak-best-inline');
      bestInline.textContent = peakStreak > streak ? `Session best: ${peakStreak}` : (bestStreak > streak ? `Personal best: ${bestStreak}` : '');
    }

    // â”€â”€ Next question â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function nextQuestion() {
      if (pool.length === 0) {
        endGame(true); // exhausted pool â€” incredible
        return;
      }

      answered = false;
      gameOver = false;

      // Pop from pool
      current = pool.pop();

      // Render meta
      const meta = document.getElementById('q-meta');
      meta.innerHTML = '';
      const domainBadge = el('span', 'q-badge badge-domain', DOMAIN_NAMES[current.domain_code] || current.domain_code);
      const angleBadge  = el('span', 'q-badge badge-angle',  ANGLE_LABELS[current.angle] || current.angle || '');
      const subBadge    = el('span', 'q-badge badge-sub',    current.subdomain || '');
      meta.appendChild(domainBadge);
      if (current.angle) meta.appendChild(angleBadge);
      if (current.subdomain) meta.appendChild(subBadge);

      // Render question
      document.getElementById('q-text').textContent = current.question;
      document.getElementById('q-card').style.animation = 'none';
      void document.getElementById('q-card').offsetWidth;
      document.getElementById('q-card').style.animation = '';

      // Render options
      const list = document.getElementById('options-list');
      list.innerHTML = '';
      const opts = current.options;
      Object.entries(opts).forEach(([letter, text]) => {
        const div = document.createElement('div');
        div.className = 'option';
        div.dataset.letter = letter;
        div.innerHTML = `<div class="opt-letter">${letter}</div><div class="opt-text">${text}</div>`;
        div.onclick = () => selectOption(letter);
        list.appendChild(div);
      });

      // Reset feedback
      const fb = document.getElementById('feedback-bar');
      fb.className = 'feedback-bar';
      document.getElementById('next-btn').classList.remove('visible');
    }

    function el(tag, cls, text) {
      const e = document.createElement(tag);
      e.className = cls;
      e.textContent = text;
      return e;
    }

    // â”€â”€ Answer handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function selectOption(letter) {
      if (answered) return;
      answered = true;

      const correct = current.correct_answer;
      const isRight = letter === correct;

      // Lock + style all options
      document.querySelectorAll('.option').forEach(opt => {
        opt.classList.add('locked');
        const l = opt.dataset.letter;
        if (l === correct) opt.classList.add('correct');
        else if (l === letter && !isRight) opt.classList.add('wrong');
        else opt.classList.add('dimmed');
      });

      if (isRight) {
        streak++;
        if (streak > bestStreak) {
          bestStreak = streak;
          localStorage.setItem(STORAGE_KEY, bestStreak);
        }
        bumpStreakDisplay();
        updateNavStreak();
        showFeedback(true, correct);
        document.getElementById('next-btn').classList.add('visible');
      } else {
        lastWrong = current;
        if (streak > peakStreak) peakStreak = streak;
        streak = 0;
        loseLife();
        if (livesLeft <= 0) {
          showFeedback(false, correct);
          setTimeout(() => endGame(false), 1200);
        } else {
          showFeedback(false, correct, livesLeft);
          bumpStreakDisplay();
          updateNavStreak();
          document.getElementById('next-btn').classList.add('visible');
        }
      }
    }

    function showFeedback(isRight, correct, remainingLives = 0) {
      const fb   = document.getElementById('feedback-bar');
      const icon = document.getElementById('feedback-icon');
      const msg  = document.getElementById('feedback-msg');
      const sub  = document.getElementById('feedback-sub');
      fb.className = 'feedback-bar ' + (isRight ? 'correct' : 'wrong');
      icon.textContent = isRight ? 'âœ“' : 'âœ—';
      if (isRight) {
        msg.textContent = 'Correct!';
        sub.textContent = `Streak: ${streak}`;
      } else if (remainingLives > 0) {
        msg.textContent = 'Incorrect â€” streak reset';
        const hearts = '\u2764\uFE0F'.repeat(remainingLives);
        sub.textContent = `Correct: ${correct} Â· ${hearts} ${remainingLives} ${remainingLives === 1 ? 'life' : 'lives'} left`;
      } else {
        msg.textContent = 'Incorrect â€” no lives left';
        sub.textContent = `Correct answer: ${correct}`;
      }
    }

    // â”€â”€ Game over â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function endGame(exhausted) {
      gameOver = true;
      const finalStreak = Math.max(streak, peakStreak);
      const isNewBest = finalStreak > 0 && finalStreak >= bestStreak && !exhausted;
      if (finalStreak > bestStreak) {
        bestStreak = finalStreak;
        localStorage.setItem(STORAGE_KEY, bestStreak);
      }

      document.getElementById('gameover-icon').textContent = exhausted ? 'ðŸ†' : (finalStreak >= 10 ? 'ðŸ”¥' : 'ðŸ’¥');
      document.getElementById('gameover-streak').textContent = finalStreak;
      document.getElementById('stat-best').textContent = bestStreak;
      document.getElementById('stat-domain').textContent =
        domainParam === 'mixed' ? 'Mixed' : CFG_DOMAINS.join(', ');

      if (isNewBest || exhausted) {
        document.getElementById('new-best-badge').style.display = 'inline-flex';
      }

      if (lastWrong && !exhausted) {
        document.getElementById('gameover-wrong-q').textContent = lastWrong.question;
        const opts = lastWrong.options;
        const ca   = lastWrong.correct_answer;
        document.getElementById('gameover-answer-text').textContent = `${ca}: ${opts[ca]}`;
        document.getElementById('gameover-wrong').style.display = 'block';
      } else {
        document.getElementById('gameover-wrong').style.display = 'none';
      }

      showScreen('gameover');
    }

    function restartStreak() {
      streak   = 0;
      lastWrong = null;
      answered  = false;
      gameOver  = false;
      // Re-shuffle pool (refill from scratch by reloading)
      location.reload();
    }

    // â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    loadQuestions();
  </script>
</body>
</html>
