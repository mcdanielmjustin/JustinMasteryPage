<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Brain Pathology | MasteryPage</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #09090b;
      --bg2: #0f0f11;
      --bg3: #18181b;
      --card: #1c1c1f;
      --rose: #f43f5e;
      --rose-light: #fb7185;
      --rose-dark: #be123c;
      --gold: #d4a054;
      --gold-light: #e4b76a;
      --green: #34d399;
      --red: #ef4444;
      --text: #fafafa;
      --text2: #a8a8b3;
      --text3: #6b6b76;
      --border: rgba(255,255,255,0.07);
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }

    @keyframes pulseGlow { 0%,100%{opacity:.08} 50%{opacity:.15} }
    @keyframes fadeInUp { from{opacity:0;transform:translateY(18px)} to{opacity:1;transform:translateY(0)} }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    @keyframes shimmer { 0%{background-position:-400px 0} 100%{background-position:400px 0} }
    @keyframes pulseRegion { 0%,100%{opacity:.72} 50%{opacity:1;filter:drop-shadow(0 0 10px rgba(218,155,60,0.90))} }
    @keyframes floatIn { from{opacity:0;transform:translateY(14px)} to{opacity:1;transform:translateY(0)} }
    @keyframes shake { 0%,100%{transform:translateX(0)} 20%,60%{transform:translateX(-4px)} 40%,80%{transform:translateX(4px)} }
    @keyframes slideDown { from{opacity:0;transform:translateY(-8px)} to{opacity:1;transform:translateY(0)} }
    @keyframes wrongFlash { 0%,100%{opacity:1} 30%{opacity:0.4} }

    .blob {
      position: fixed; border-radius: 50%; filter: blur(100px);
      pointer-events: none; animation: pulseGlow 6s ease-in-out infinite; z-index: 0;
    }
    .blob-rose   { width:500px; height:500px; background:#be123c; top:-150px; right:-140px; }
    .blob-purple { width:450px; height:450px; background:#9333ea; bottom:-140px; left:-120px; animation-delay:3s; }

    nav {
      position: fixed; top:0; left:0; right:0; z-index:20; height:56px;
      background: rgba(9,9,11,0.85); backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; padding: 0 20px; gap: 12px;
    }
    .logo { display:flex; align-items:center; gap:8px; text-decoration:none; color:inherit; }
    .logo-icon {
      width:30px; height:30px; border-radius:7px;
      background: linear-gradient(135deg,#9333ea,#6d28d9);
      display:flex; align-items:center; justify-content:center;
      font-weight:700; font-size:14px; color:#fff; flex-shrink:0;
    }
    .logo-title { font-weight:700; font-size:14px; }
    .nav-spacer { flex:1; }
    .nav-score {
      font-size:13px; color:var(--text2);
      display:flex; align-items:center; gap:6px;
    }
    .nav-score strong { color: var(--green); font-weight:700; }
    .back-btn {
      background: none; border: 1px solid var(--border); border-radius:8px;
      padding: 5px 12px; font-size:12px; color:var(--text2); cursor:pointer;
      transition: border-color 0.2s, color 0.2s;
    }
    .back-btn:hover { border-color: rgba(255,255,255,0.2); color:#fff; }

    /* ── SCREENS ──────────────────────────────────────────────────────────── */
    .screen { display:none; position:relative; z-index:1; }

    /* Loading */
    #screen-loading.active {
      display:flex; align-items:center; justify-content:center;
      min-height: 100vh;
      font-size:14px; color:var(--text3);
    }

    /* Quiz */
    #screen-quiz.active {
      padding: 72px 16px 40px;
      display: flex; flex-direction: column; align-items: center;
    }

    .progress-wrap {
      width: 100%; max-width: 700px; margin-bottom: 20px;
    }
    .progress-bar-bg {
      height:4px; background:rgba(255,255,255,0.07); border-radius:4px; overflow:hidden;
      margin-bottom:8px;
    }
    .progress-bar-fill {
      height:100%; background: linear-gradient(90deg,var(--rose-dark),var(--rose-light));
      border-radius:4px; transition: width 0.4s ease;
    }
    .progress-meta {
      display:flex; justify-content:space-between; align-items:center;
      font-size:11px; color:var(--text3); font-weight:500;
    }
    .progress-meta .correct-badge {
      color:var(--green); font-weight:700;
    }

    .question-card {
      width: 100%; max-width: 700px;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 24px;
      margin-bottom: 20px;
    }
    .q-label {
      font-size:10px; font-weight:600; letter-spacing:0.1em;
      text-transform:uppercase; color:var(--rose-light); margin-bottom:10px;
    }
    .q-text {
      font-size:15px; line-height:1.7; color:var(--text);
    }

    /* SVG Brain */
    .brain-container {
      width: 100%; max-width: 700px;
      position: relative; margin-bottom: 16px;
    }
    #brain-svg {
      width: 100%; height: auto;
      display: block;
      overflow: visible;
    }

    /* Region states */
    .brain-region {
      cursor: default;
      filter: drop-shadow(1px 3px 9px rgba(30,8,4,0.80));
      transition: filter 0.22s;
    }
    .brain-region path, .brain-region ellipse { transition: fill 0.2s, opacity 0.2s, filter 0.2s; }

    .brain-region.region-active { cursor: pointer; }
    .brain-region.region-active path:hover,
    .brain-region.region-active ellipse:hover { filter: brightness(1.22) saturate(1.1); }

    .brain-region.region-dimmed { opacity: 0.16; pointer-events: none; }

    /* Study mode */
    .svg-study-mode .brain-region { cursor: pointer; }
    .svg-study-mode .brain-region:hover {
      filter: drop-shadow(0 0 10px rgba(255,200,160,0.30)) brightness(1.14);
    }
    .brain-region.study-selected {
      filter: drop-shadow(0 0 14px rgba(212,160,84,0.75)) brightness(1.18) !important;
    }
    .brain-region.study-selected path,
    .brain-region.study-selected ellipse {
      stroke: var(--gold) !important; stroke-width: 2.5 !important;
    }

    .brain-region.region-selected path,
    .brain-region.region-selected ellipse {
      stroke: var(--gold) !important; stroke-width: 3 !important;
      stroke-dasharray: 6 3 !important;
    }

    .brain-region.region-highlighted path,
    .brain-region.region-highlighted ellipse {
      animation: pulseRegion 1.5s ease-in-out infinite;
    }

    .brain-region.region-correct path,
    .brain-region.region-correct ellipse {
      fill: rgba(52,211,153,0.75) !important;
      stroke: #34d399 !important; stroke-width: 2.5 !important;
      stroke-dasharray: none !important;
      animation: none !important;
    }

    .brain-region.region-wrong path,
    .brain-region.region-wrong ellipse {
      fill: rgba(239,68,68,0.65) !important;
      stroke: #ef4444 !important; stroke-width: 2.5 !important;
      stroke-dasharray: none !important;
      animation: wrongFlash 0.4s ease, shake 0.35s ease !important;
    }

    /* Study mode prompt */
    .study-prompt {
      width: 100%; max-width: 700px; text-align: center;
      padding: 8px 0 2px;
      font-size: 13px; color: var(--text3);
      animation: floatIn 0.5s ease both;
    }
    .study-prompt strong { color: var(--rose-light); font-weight: 600; }

    /* Info panel — slides up from bottom */
    .info-panel {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 30;
      background: rgba(10,10,14,0.97);
      backdrop-filter: blur(24px);
      border-top: 1px solid rgba(255,255,255,0.09);
      transform: translateY(100%);
      transition: transform 0.38s cubic-bezier(0.34,1.15,0.64,1);
      max-height: 54vh; overflow-y: auto;
    }
    .info-panel.open { transform: translateY(0); }
    .info-panel-inner {
      padding: 22px 28px 36px; max-width: 840px; margin: 0 auto; position: relative;
    }
    .info-close {
      position: absolute; top: 16px; right: 22px;
      background: none; border: none; color: var(--text3);
      font-size: 22px; line-height: 1; cursor: pointer;
      transition: color 0.18s;
    }
    .info-close:hover { color: var(--text); }
    .info-region-name {
      font-family: 'Instrument Serif', Georgia, serif;
      font-size: 1.55rem; color: var(--text); margin-bottom: 3px;
    }
    .info-ba {
      font-size: 11px; color: var(--rose-light); letter-spacing: 0.03em;
      margin-bottom: 18px; display: flex; align-items: baseline; gap: 6px;
    }
    .info-meta-label {
      font-size: 9px; font-weight: 600; letter-spacing: 0.1em;
      text-transform: uppercase; color: var(--text3);
    }
    .info-cols {
      display: flex; gap: 28px; flex-wrap: wrap; margin-bottom: 14px;
    }
    .info-col { flex: 1; min-width: 200px; }
    .info-section-label {
      font-size: 10px; font-weight: 600; letter-spacing: 0.1em;
      text-transform: uppercase; color: var(--rose-light); margin-bottom: 8px;
    }
    .info-list {
      list-style: none; padding: 0; display: flex; flex-direction: column; gap: 6px;
    }
    .info-list li {
      font-size: 13px; color: var(--text2); line-height: 1.5;
      padding-left: 16px; position: relative;
    }
    .info-list li::before {
      content: '·'; position: absolute; left: 2px;
      color: var(--rose); font-weight: 700;
    }
    .info-vascular {
      font-size: 12px; color: var(--text3); margin-top: 4px;
      display: flex; align-items: baseline; gap: 6px;
    }
    .info-vascular span { color: var(--gold); font-weight: 500; font-size: 12px; }

    /* Tooltip */
    .region-tooltip {
      position: fixed; pointer-events: none;
      background: rgba(9,9,11,0.92);
      border: 1px solid var(--gold);
      border-radius: 7px; padding: 5px 12px;
      font-size: 12px; color: var(--gold-light);
      white-space: nowrap; z-index: 100;
      opacity: 0; transition: opacity 0.15s;
    }
    .region-tooltip.visible { opacity: 1; }

    /* Highlighted label */
    .highlighted-label {
      text-align: center; font-size: 12px; color: var(--gold-light);
      margin-bottom: 8px; font-weight: 600; letter-spacing: 0.05em;
    }

    /* Chips (type 2) */
    .chips-answer-wrap {
      width: 100%; max-width: 700px;
      display: flex; flex-direction: column; gap: 8px;
      margin-bottom: 16px;
    }
    .answer-chip {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 13px 16px;
      font-size: 14px; line-height: 1.5; color: var(--text2);
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s, color 0.2s;
      text-align: left;
    }
    .answer-chip:hover:not(.chip-disabled) {
      border-color: rgba(244,63,94,0.35); color: var(--text);
    }
    .answer-chip.chip-selected {
      background: rgba(212,160,84,0.1);
      border-color: var(--gold);
      color: var(--gold-light);
    }
    .answer-chip.chip-correct {
      background: rgba(52,211,153,0.12);
      border-color: var(--green);
      color: var(--green);
    }
    .answer-chip.chip-wrong {
      background: rgba(239,68,68,0.1);
      border-color: var(--red);
      color: var(--red);
    }
    .answer-chip.chip-disabled { cursor: default; }

    /* Action row */
    .action-row {
      width: 100%; max-width: 700px;
      display: flex; gap: 10px; margin-bottom: 16px;
    }
    .submit-btn {
      flex: 1;
      background: linear-gradient(135deg, var(--rose-dark), #9f1239);
      border: none; border-radius: 12px;
      padding: 13px 20px;
      font-size: 14px; font-weight: 700; color: #fff;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.2s;
      display: none;
    }
    .submit-btn.visible { display: block; }
    .submit-btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .next-btn {
      flex: 1;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.15); border-radius: 12px;
      padding: 13px 20px;
      font-size: 14px; font-weight: 600; color: var(--text2);
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s, background 0.2s;
      display: none;
    }
    .next-btn.visible { display: block; }
    .next-btn:hover { border-color: rgba(255,255,255,0.3); color: var(--text); background: rgba(255,255,255,0.08); }

    /* Explanation */
    .explanation-box {
      width: 100%; max-width: 700px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 14px;
      padding: 18px 20px;
      display: none;
      animation: slideDown 0.3s ease-out both;
      margin-bottom: 16px;
    }
    .explanation-box.visible { display: block; }
    .explanation-box.correct-box { border-color: rgba(52,211,153,0.3); background: rgba(52,211,153,0.05); }
    .explanation-box.wrong-box  { border-color: rgba(239,68,68,0.3);  background: rgba(239,68,68,0.05); }
    .explanation-verdict {
      font-size: 12px; font-weight: 700; letter-spacing: 0.08em;
      text-transform: uppercase; margin-bottom: 8px;
    }
    .correct-box .explanation-verdict { color: var(--green); }
    .wrong-box  .explanation-verdict  { color: var(--red); }
    .explanation-text {
      font-size: 13px; line-height: 1.7; color: var(--text2);
    }

    /* ── RESULTS SCREEN ─────────────────────────────────────────────────── */
    #screen-results.active {
      padding: 80px 24px 60px;
      display: flex; flex-direction: column; align-items: center; gap: 24px;
    }
    .results-card {
      width: 100%; max-width: 520px;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 22px;
      padding: 36px;
      text-align: center;
      animation: fadeInUp 0.5s ease-out both;
    }
    .score-ring {
      width: 110px; height: 110px;
      border-radius: 50%;
      background: conic-gradient(var(--green) 0% var(--pct,0%), rgba(255,255,255,0.07) 0% 100%);
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 20px;
    }
    .score-ring-inner {
      width: 80px; height: 80px;
      border-radius: 50%; background: var(--bg);
      display: flex; align-items: center; justify-content: center;
      flex-direction: column;
    }
    .score-pct { font-size: 22px; font-weight: 800; color: var(--green); }
    .score-sub { font-size: 10px; color: var(--text3); }
    .results-title {
      font-family: 'Instrument Serif', Georgia, serif;
      font-size: 1.6rem; margin-bottom: 8px;
    }
    .results-detail { font-size: 13px; color: var(--text2); line-height: 1.6; }
    .results-actions { display:flex; gap:12px; margin-top:24px; flex-wrap:wrap; }
    .btn-primary {
      flex:1; min-width:120px;
      background: linear-gradient(135deg,var(--rose-dark),#9f1239);
      border:none; border-radius:12px; padding:12px 20px;
      font-size:14px; font-weight:700; color:#fff; cursor:pointer;
      transition: opacity 0.2s, transform 0.2s;
    }
    .btn-primary:hover { opacity:.9; transform:translateY(-1px); }
    .btn-secondary {
      flex:1; min-width:120px;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.15); border-radius:12px;
      padding:12px 20px;
      font-size:14px; font-weight:600; color:var(--text2); cursor:pointer;
      transition: border-color 0.2s, color 0.2s;
    }
    .btn-secondary:hover { border-color:rgba(255,255,255,0.3); color:var(--text); }

    /* ── REVIEW SCREEN ──────────────────────────────────────────────────── */
    #screen-review.active {
      padding: 72px 16px 60px;
      display: flex; flex-direction: column; align-items: center; gap: 20px;
    }
    .review-header {
      width: 100%; max-width: 700px;
      font-size: 16px; font-weight: 700; color: var(--text);
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    .review-item {
      width: 100%; max-width: 700px;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
    }
    .review-q { font-size:14px; line-height:1.6; color:var(--text); margin-bottom:14px; }
    .review-brain-wrap { margin-bottom:14px; }
    .review-explanation {
      font-size:13px; line-height:1.7; color:var(--text2);
      border-top: 1px solid var(--border);
      padding-top: 12px; margin-top:4px;
    }
    .review-back-btn {
      width: 100%; max-width: 700px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.15); border-radius:12px;
      padding:12px 20px; font-size:14px; font-weight:600; color:var(--text2);
      cursor:pointer; transition:border-color 0.2s,color 0.2s;
    }
    .review-back-btn:hover { border-color:rgba(255,255,255,0.3); color:var(--text); }

    /* Sub-region strips: narrower shapes look cleaner with a thinner border */
    #motor_cortex path, #somatosensory_cortex path,
    #prefrontal_cortex path, #brocas_area path, #wernickes_area path {
      stroke-width: 0.9 !important;
    }

    /* SVG Labels */
    .region-text {
      font-size: 10px; font-weight: 700; fill: rgba(38,12,8,0.70);
      pointer-events: none; text-anchor: middle; dominant-baseline: middle;
      letter-spacing: 0.03em;
    }

    @media (max-width: 500px) {
      .question-card { padding: 18px; }
      .q-text { font-size: 14px; }
    }
  </style>
</head>
<body>
  <div class="blob blob-rose"></div>
  <div class="blob blob-purple"></div>

  <!-- TOOLTIP -->
  <div class="region-tooltip" id="tooltip"></div>

  <nav>
    <a class="logo" href="brain-settings.html">
      <div class="logo-icon">M</div>
      <span class="logo-title">MasteryPage</span>
    </a>
    <div class="nav-spacer"></div>
    <div class="nav-score" id="nav-score" style="display:none">
      <strong id="nav-correct">0</strong> / <span id="nav-total">0</span> correct
    </div>
    <button class="back-btn" onclick="location.href='brain-settings.html'">&#8592; Settings</button>
  </nav>

  <!-- LOADING -->
  <div class="screen active" id="screen-loading">Loading&hellip;</div>

  <!-- QUIZ -->
  <div class="screen" id="screen-quiz">
    <div class="progress-wrap">
      <div class="progress-bar-bg">
        <div class="progress-bar-fill" id="progress-fill" style="width:0%"></div>
      </div>
      <div class="progress-meta">
        <span id="progress-label">Question 0 of 0</span>
        <span class="correct-badge" id="progress-correct">&#10003; 0</span>
      </div>
    </div>

    <div class="question-card">
      <div class="q-label" id="q-label">Brain Pathology</div>
      <div class="q-text" id="q-text"></div>
    </div>

    <div class="highlighted-label" id="highlighted-label" style="display:none">
      &#9733; This region is damaged
    </div>

    <!-- SVG Brain Diagram -->
    <div class="brain-container">
      <svg id="brain-svg" viewBox="0 0 520 360" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <!-- Drop shadow around whole brain -->
          <filter id="brain-shadow" x="-8%" y="-5%" width="120%" height="120%">
            <feDropShadow dx="3" dy="6" stdDeviation="10" flood-color="#000" flood-opacity="0.55"/>
          </filter>
          <!-- Glow for .region-highlighted state -->
          <filter id="region-glow" x="-18%" y="-18%" width="136%" height="136%">
            <feGaussianBlur stdDeviation="5" result="b"/>
            <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>

          <!-- ── Per-region radial gradients — realistic brain tissue palette ── -->
          <!-- All regions: pinkish-tan cortex, reddish-brown mid, deep burgundy shadow -->
          <!-- Subtle tonal shifts distinguish regions without breaking the naturalistic look -->

          <!-- ── Per-region radial gradients — 4-stop photorealistic tissue palette ──
               Each region uses 4 tonal stops: gloss peak → lit surface → mid-shadow → deep shadow.
               Focal point (fx/fy) is offset further upper-left than center (cx/cy) to simulate
               a strong directional light from upper-left. Subtle tonal shifts per region
               preserve naturalistic variation without color-coding. -->

          <!-- Frontal lobe — warm mid-pink reference tone -->
          <radialGradient id="g-frontal" cx="34%" cy="30%" r="68%" fx="20%" fy="16%">
            <stop offset="0%"   stop-color="#EEC4A8"/>
            <stop offset="20%"  stop-color="#C8845E"/>
            <stop offset="55%"  stop-color="#944030"/>
            <stop offset="100%" stop-color="#4E1C0E"/>
          </radialGradient>
          <!-- Prefrontal cortex — lightest, anterior surface catches most light -->
          <radialGradient id="g-pfc" cx="38%" cy="32%" r="62%" fx="22%" fy="18%">
            <stop offset="0%"   stop-color="#F2CAB0"/>
            <stop offset="20%"  stop-color="#CE8C68"/>
            <stop offset="55%"  stop-color="#9C4C38"/>
            <stop offset="100%" stop-color="#542210"/>
          </radialGradient>
          <!-- Broca's area — inferior frontal, more shadowed -->
          <radialGradient id="g-broca" cx="40%" cy="36%" r="60%" fx="24%" fy="22%">
            <stop offset="0%"   stop-color="#E2B494"/>
            <stop offset="20%"  stop-color="#C07858"/>
            <stop offset="55%"  stop-color="#8C3C2C"/>
            <stop offset="100%" stop-color="#481A0C"/>
          </radialGradient>
          <!-- Motor cortex — brightly lit vertical strip -->
          <radialGradient id="g-motor" cx="48%" cy="26%" r="70%" fx="34%" fy="14%">
            <stop offset="0%"   stop-color="#EFBEA4"/>
            <stop offset="20%"  stop-color="#CC8262"/>
            <stop offset="55%"  stop-color="#964438"/>
            <stop offset="100%" stop-color="#4E1E10"/>
          </radialGradient>
          <!-- Parietal lobe — slightly cooler, gray-rose -->
          <radialGradient id="g-parietal" cx="44%" cy="28%" r="66%" fx="28%" fy="16%">
            <stop offset="0%"   stop-color="#E4B49E"/>
            <stop offset="20%"  stop-color="#BE7860"/>
            <stop offset="55%"  stop-color="#8A3E30"/>
            <stop offset="100%" stop-color="#481A0E"/>
          </radialGradient>
          <!-- Somatosensory cortex — narrow lit strip, very bright at top -->
          <radialGradient id="g-sensory" cx="48%" cy="26%" r="70%" fx="34%" fy="14%">
            <stop offset="0%"   stop-color="#F6CAB4"/>
            <stop offset="20%"  stop-color="#D08870"/>
            <stop offset="55%"  stop-color="#9C4C40"/>
            <stop offset="100%" stop-color="#52221A"/>
          </radialGradient>
          <!-- Temporal lobe — olive-warm, deeper shadow at inferior margin -->
          <radialGradient id="g-temporal" cx="38%" cy="30%" r="66%" fx="22%" fy="18%">
            <stop offset="0%"   stop-color="#E0A882"/>
            <stop offset="20%"  stop-color="#B87050"/>
            <stop offset="55%"  stop-color="#843A28"/>
            <stop offset="100%" stop-color="#3E1408"/>
          </radialGradient>
          <!-- Wernicke's area — warm mid-tone -->
          <radialGradient id="g-wernicke" cx="40%" cy="34%" r="62%" fx="24%" fy="20%">
            <stop offset="0%"   stop-color="#DEAA84"/>
            <stop offset="20%"  stop-color="#B66C4E"/>
            <stop offset="55%"  stop-color="#823A28"/>
            <stop offset="100%" stop-color="#3C1408"/>
          </radialGradient>
          <!-- Occipital lobe — cooler/darker, posterior pole receives less direct light -->
          <radialGradient id="g-occipital" cx="44%" cy="34%" r="64%" fx="28%" fy="20%">
            <stop offset="0%"   stop-color="#D89A84"/>
            <stop offset="20%"  stop-color="#AA6450"/>
            <stop offset="55%"  stop-color="#7A3428"/>
            <stop offset="100%" stop-color="#3A1210"/>
          </radialGradient>
          <!-- Cerebellum — distinctly paler/grayer; less pigmented tissue -->
          <radialGradient id="g-cerebellum" cx="44%" cy="28%" r="66%" fx="28%" fy="14%">
            <stop offset="0%"   stop-color="#D8B4A2"/>
            <stop offset="20%"  stop-color="#A87C6A"/>
            <stop offset="55%"  stop-color="#784A40"/>
            <stop offset="100%" stop-color="#3A1C18"/>
          </radialGradient>
          <!-- Brainstem — gray-pink, white-matter dominant, column-like -->
          <radialGradient id="g-brainstem" cx="48%" cy="28%" r="70%" fx="32%" fy="14%">
            <stop offset="0%"   stop-color="#C6AE9C"/>
            <stop offset="20%"  stop-color="#967060"/>
            <stop offset="55%"  stop-color="#684448"/>
            <stop offset="100%" stop-color="#301820"/>
          </radialGradient>

          <!-- Specular highlight: broad warm glow (moist pial surface, biological tissue) -->
          <radialGradient id="g-specular" cx="27%" cy="19%" r="54%" fx="18%" fy="10%">
            <stop offset="0%"   stop-color="rgba(255,232,215,0.30)"/>
            <stop offset="30%"  stop-color="rgba(255,220,200,0.12)"/>
            <stop offset="60%"  stop-color="rgba(255,210,190,0.04)"/>
            <stop offset="100%" stop-color="rgba(255,200,180,0)"/>
          </radialGradient>
          <!-- Tight specular hotspot — small brilliant gloss point at light source angle -->
          <radialGradient id="g-hotspot" cx="20%" cy="12%" r="18%" fx="16%" fy="8%">
            <stop offset="0%"   stop-color="rgba(255,248,238,0.72)"/>
            <stop offset="25%"  stop-color="rgba(255,235,218,0.30)"/>
            <stop offset="55%"  stop-color="rgba(255,222,205,0.08)"/>
            <stop offset="100%" stop-color="rgba(255,210,190,0)"/>
          </radialGradient>
          <!-- Subsurface scatter: amber-orange glow — light penetrates 1-2mm into cortex -->
          <radialGradient id="g-scatter" cx="42%" cy="48%" r="60%" fx="36%" fy="40%">
            <stop offset="0%"   stop-color="rgba(210,110,60,0.18)"/>
            <stop offset="30%"  stop-color="rgba(195,88,44,0.10)"/>
            <stop offset="65%"  stop-color="rgba(178,66,30,0.04)"/>
            <stop offset="100%" stop-color="rgba(160,50,22,0)"/>
          </radialGradient>
          <!-- Ambient: warm top-lit → deep cool shadow at inferior margin -->
          <linearGradient id="g-ambient" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%"   stop-color="rgba(255,228,208,0.14)"/>
            <stop offset="40%"  stop-color="rgba(230,185,162,0.04)"/>
            <stop offset="70%"  stop-color="rgba(80,20,8,0.08)"/>
            <stop offset="100%" stop-color="rgba(24,5,2,0.38)"/>
          </linearGradient>
          <!-- Rim gradient: lit upper-left → deep shadow lower-right -->
          <linearGradient id="g-rim" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%"   stop-color="rgba(255,230,212,0.46)"/>
            <stop offset="35%"  stop-color="rgba(225,165,135,0.18)"/>
            <stop offset="70%"  stop-color="rgba(80,20,8,0.12)"/>
            <stop offset="100%" stop-color="rgba(20,4,2,0.40)"/>
          </linearGradient>
          <!-- ════ REALISM FILTERS ════ -->
          <!-- f-sulcal: blurred dark penumbra makes each stroke look like a deep groove -->
          <filter id="f-sulcal" x="-24%" y="-24%" width="148%" height="148%" color-interpolation-filters="sRGB">
            <feGaussianBlur stdDeviation="3.0" in="SourceGraphic" result="blur"/>
            <feColorMatrix type="matrix"
              values="0 0 0 0 0.04   0 0 0 0 0.006   0 0 0 0 0.003   0 0 0 9 -0.6"
              in="blur" result="shadow"/>
            <feMerge>
              <feMergeNode in="shadow"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
          <!-- f-gyrus: soft warm glow around gyral ridge highlights -->
          <filter id="f-gyrus" x="-18%" y="-18%" width="136%" height="136%" color-interpolation-filters="sRGB">
            <feGaussianBlur stdDeviation="2.0" in="SourceGraphic" result="glow"/>
            <feColorMatrix type="matrix"
              values="0 0 0 0 1.0   0 0 0 0 0.87   0 0 0 0 0.70   0 0 0 4 0"
              in="glow" result="warm-glow"/>
            <feMerge>
              <feMergeNode in="warm-glow"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
          <!-- f-cortex: fractal-noise overlay creates organic cortical micro-texture -->
          <filter id="f-cortex" x="-2%" y="-2%" width="104%" height="104%" color-interpolation-filters="sRGB">
            <feTurbulence type="fractalNoise" baseFrequency="0.030 0.042" numOctaves="6" seed="11" result="noise"/>
            <feComponentTransfer in="noise" result="warm-noise">
              <feFuncR type="linear" slope="0.55" intercept="0.08"/>
              <feFuncG type="linear" slope="0.30" intercept="0.04"/>
              <feFuncB type="linear" slope="0.18" intercept="0.02"/>
              <feFuncA type="linear" slope="0.27" intercept="0"/>
            </feComponentTransfer>
            <feComposite in="warm-noise" in2="SourceGraphic" operator="in" result="masked"/>
            <feMerge>
              <feMergeNode in="SourceGraphic"/>
              <feMergeNode in="masked"/>
            </feMerge>
          </filter>

          <!-- ClipPath for cerebellum folia -->
          <clipPath id="clip-cb">
            <path d="M 285,280 C 315,275 345,275 372,281 C 400,286 428,296 445,314
                     C 450,330 445,347 426,354 C 406,361 378,362 350,356
                     C 324,350 298,338 280,324 C 264,312 262,298 272,286
                     C 276,282 280,280 285,280 Z"/>
          </clipPath>
        </defs>

        <!-- Warm ambient backdrop — subtle deep-burgundy oval unifies the separated pieces -->
        <ellipse cx="248" cy="195" rx="228" ry="174"
                 fill="rgba(20,5,3,0.52)" filter="url(#brain-shadow)"/>

        <!-- ══ MAIN LOBES — draw deepest first (occipital→parietal→temporal→frontal) ══ -->

        <!-- 1. OCCIPITAL LOBE — posterior crescent -->
        <g id="occipital_lobe" class="brain-region" data-region="occipital_lobe" data-label="Occipital Lobe" transform="translate(11,1)">
          <path d="M 378,52
                   C 422,82 456,132 462,180
                   C 465,225 450,265 425,282
                   C 405,293 382,298 360,280
                   C 364,272 372,264 384,252
                   C 402,236 415,212 415,186
                   C 412,148 400,102 378,52 Z"
                fill="url(#g-occipital)" stroke="rgba(42,12,8,0.55)" stroke-width="1.4"/>
          <path d="M 378,52 C 422,82 456,132 462,180 C 465,225 450,265 425,282 C 405,293 382,298 360,280 C 364,272 372,264 384,252 C 402,236 415,212 415,186 C 412,148 400,102 378,52 Z" fill="url(#g-scatter)" pointer-events="none"/>
          <text class="region-text" x="420" y="200">Occipital</text>
        </g>

        <!-- 2. PARIETAL LOBE — top-centre, behind central sulcus -->
        <g id="parietal_lobe" class="brain-region" data-region="parietal_lobe" data-label="Parietal Lobe" transform="translate(7,-5)">
          <path d="M 212,18
                   C 265,14 330,26 378,52
                   C 395,115 415,186 408,238
                   C 398,258 380,272 360,280
                   C 344,270 323,254 317,238
                   C 314,226 314,210 315,204
                   C 285,186 252,184 215,188
                   C 212,130 212,72 212,18 Z"
                fill="url(#g-parietal)" stroke="rgba(42,12,8,0.55)" stroke-width="1.4"/>
          <path d="M 212,18 C 265,14 330,26 378,52 C 395,115 415,186 408,238 C 398,258 380,272 360,280 C 344,270 323,254 317,238 C 314,226 314,210 315,204 C 285,186 252,184 215,188 C 212,130 212,72 212,18 Z" fill="url(#g-scatter)" pointer-events="none"/>
          <text class="region-text" x="296" y="128">Parietal</text>
        </g>

        <!-- 3. TEMPORAL LOBE — below Sylvian fissure -->
        <g id="temporal_lobe" class="brain-region" data-region="temporal_lobe" data-label="Temporal Lobe" transform="translate(-4,8)">
          <path d="M 104,196
                   C 148,187 196,184 215,188
                   C 252,185 285,187 315,204
                   C 317,218 323,236 334,250
                   C 344,262 354,272 360,280
                   C 345,285 328,286 310,284
                   C 285,292 258,296 232,295
                   C 205,296 178,292 148,278
                   C 118,260 96,240 78,222
                   C 72,208 76,200 104,196 Z"
                fill="url(#g-temporal)" stroke="rgba(42,12,8,0.55)" stroke-width="1.4"/>
          <path d="M 104,196 C 148,187 196,184 215,188 C 252,185 285,187 315,204 C 317,218 323,236 334,250 C 344,262 354,272 360,280 C 345,285 328,286 310,284 C 285,292 258,296 232,295 C 205,296 178,292 148,278 C 118,260 96,240 78,222 C 72,208 76,200 104,196 Z" fill="url(#g-scatter)" pointer-events="none"/>
          <text class="region-text" x="210" y="252">Temporal</text>
        </g>

        <!-- 4. FRONTAL LOBE — large front region, on top -->
        <g id="frontal_lobe" class="brain-region" data-region="frontal_lobe" data-label="Frontal Lobe" transform="translate(-10,-3)">
          <path d="M 212,18
                   C 168,14 118,22 85,46
                   C 55,68 38,110 40,155
                   C 40,178 48,198 72,204
                   C 88,210 102,204 104,196
                   C 148,187 196,184 215,188
                   C 212,130 212,72 212,18 Z"
                fill="url(#g-frontal)" stroke="rgba(42,12,8,0.55)" stroke-width="1.4"/>
          <path d="M 212,18 C 168,14 118,22 85,46 C 55,68 38,110 40,155 C 40,178 48,198 72,204 C 88,210 102,204 104,196 C 148,187 196,184 215,188 C 212,130 212,72 212,18 Z" fill="url(#g-scatter)" pointer-events="none"/>
          <text class="region-text" x="112" y="92">Frontal</text>
        </g>

        <!-- ══ CEREBELLUM + BRAINSTEM ══ -->

        <!-- 5. CEREBELLUM -->
        <g id="cerebellum" class="brain-region" data-region="cerebellum" data-label="Cerebellum" transform="translate(6,9)">
          <path d="M 285,280
                   C 315,275 345,275 372,281
                   C 400,286 428,296 445,314
                   C 450,330 445,347 426,354
                   C 406,361 378,362 350,356
                   C 324,350 298,338 280,324
                   C 264,312 262,298 272,286
                   C 276,282 280,280 285,280 Z"
                fill="url(#g-cerebellum)" stroke="rgba(42,12,8,0.55)" stroke-width="1.4"/>
          <path d="M 285,280 C 315,275 345,275 372,281 C 400,286 428,296 445,314 C 450,330 445,347 426,354 C 406,361 378,362 350,356 C 324,350 298,338 280,324 C 264,312 262,298 272,286 C 276,282 280,280 285,280 Z" fill="url(#g-scatter)" pointer-events="none"/>
          <text class="region-text" x="358" y="324">Cerebellum</text>
        </g>

        <!-- 6. BRAINSTEM -->
        <g id="brainstem" class="brain-region" data-region="brainstem" data-label="Brainstem" transform="translate(0,9)">
          <path d="M 238,283
                   C 254,278 270,278 284,284
                   C 288,298 288,318 282,338
                   C 276,352 265,358 252,356
                   C 240,354 228,348 225,334
                   C 222,318 224,298 238,283 Z"
                fill="url(#g-brainstem)" stroke="rgba(42,12,8,0.55)" stroke-width="1.4"/>
          <path d="M 238,283 C 254,278 270,278 284,284 C 288,298 288,318 282,338 C 276,352 265,358 252,356 C 240,354 228,348 225,334 C 222,318 224,298 238,283 Z" fill="url(#g-scatter)" pointer-events="none"/>
          <text class="region-text" x="256" y="322">Brainstem</text>
        </g>

        <!-- ══ SUB-REGIONS — drawn on top of base lobes ══ -->

        <!-- 7. MOTOR CORTEX — precentral gyrus strip (left of central sulcus) -->
        <g id="motor_cortex" class="brain-region" data-region="motor_cortex" data-label="Motor Cortex" transform="translate(-5,-6)">
          <path d="M 212,18
                   C 213,72 215,130 215,188
                   C 204,186 194,172 192,152
                   C 190,126 192,78 200,34
                   C 205,20 210,16 212,18 Z"
                fill="url(#g-motor)" stroke="rgba(42,12,8,0.55)" stroke-width="1.4"/>
          <path d="M 212,18 C 213,72 215,130 215,188 C 204,186 194,172 192,152 C 190,126 192,78 200,34 C 205,20 210,16 212,18 Z" fill="url(#g-scatter)" pointer-events="none"/>
          <text class="region-text" x="202" y="108" font-size="8" transform="rotate(-80,202,108)">Motor</text>
        </g>

        <!-- 8. SOMATOSENSORY CORTEX — postcentral gyrus strip (right of central sulcus) -->
        <g id="somatosensory_cortex" class="brain-region" data-region="somatosensory_cortex" data-label="Somatosensory Cortex" transform="translate(-3,-7)">
          <path d="M 215,188
                   C 215,130 213,72 212,18
                   C 222,14 238,12 244,20
                   C 240,72 238,130 238,188
                   C 230,188 222,188 215,188 Z"
                fill="url(#g-sensory)" stroke="rgba(42,12,8,0.55)" stroke-width="1.4"/>
          <path d="M 215,188 C 215,130 213,72 212,18 C 222,14 238,12 244,20 C 240,72 238,130 238,188 C 230,188 222,188 215,188 Z" fill="url(#g-scatter)" pointer-events="none"/>
          <text class="region-text" x="230" y="108" font-size="8" transform="rotate(-80,230,108)">Sens.</text>
        </g>

        <!-- 9. PREFRONTAL CORTEX — anterior frontal overlay -->
        <g id="prefrontal_cortex" class="brain-region" data-region="prefrontal_cortex" data-label="Prefrontal Cortex" transform="translate(-12,-2)">
          <path d="M 40,155
                   C 38,118 52,72 85,46
                   C 108,28 138,18 168,18
                   C 165,70 158,130 152,188
                   C 130,190 108,196 104,196
                   C 80,210 58,208 44,200
                   C 40,184 40,168 40,155 Z"
                fill="url(#g-pfc)" stroke="rgba(42,12,8,0.55)" stroke-width="1.4"/>
          <path d="M 40,155 C 38,118 52,72 85,46 C 108,28 138,18 168,18 C 165,70 158,130 152,188 C 130,190 108,196 104,196 C 80,210 58,208 44,200 C 40,184 40,168 40,155 Z" fill="url(#g-scatter)" pointer-events="none"/>
          <text class="region-text" x="90" y="130">PFC</text>
        </g>

        <!-- 10. BROCA'S AREA — inferior frontal gyrus -->
        <g id="brocas_area" class="brain-region" data-region="brocas_area" data-label="Broca's Area" transform="translate(-11,1)">
          <path d="M 104,196
                   C 118,192 136,189 152,188
                   C 156,165 155,142 150,122
                   C 140,108 124,108 112,120
                   C 105,132 103,160 104,196 Z"
                fill="url(#g-broca)" stroke="rgba(42,12,8,0.55)" stroke-width="1.4"/>
          <path d="M 104,196 C 118,192 136,189 152,188 C 156,165 155,142 150,122 C 140,108 124,108 112,120 C 105,132 103,160 104,196 Z" fill="url(#g-scatter)" pointer-events="none"/>
          <text class="region-text" x="130" y="152">Broca</text>
        </g>

        <!-- 11. WERNICKE'S AREA — posterior superior temporal -->
        <g id="wernickes_area" class="brain-region" data-region="wernickes_area" data-label="Wernicke's Area" transform="translate(6,5)">
          <path d="M 315,204
                   C 322,196 338,192 354,198
                   C 370,208 374,230 365,250
                   C 354,266 336,270 322,260
                   C 314,252 313,230 315,204 Z"
                fill="url(#g-wernicke)" stroke="rgba(42,12,8,0.55)" stroke-width="1.4"/>
          <path d="M 315,204 C 322,196 338,192 354,198 C 370,208 374,230 365,250 C 354,266 336,270 322,260 C 314,252 313,230 315,204 Z" fill="url(#g-scatter)" pointer-events="none"/>
          <text class="region-text" x="344" y="232">Wernicke</text>
        </g>

        <!-- ══ PIAL VASCULATURE (pointer-events: none) ══ -->
        <!-- MCA branches and PICA loops visible on lateral surface in a real brain photo -->
        <g class="vessels-layer" pointer-events="none" fill="none">

          <!-- MCA main trunk — courses along Sylvian fissure -->
          <path d="M 92,193 C 124,184 158,180 186,183 C 212,185 238,184 258,188 C 278,186 300,190 316,201"
                stroke="rgba(148,52,38,0.44)" stroke-width="1.1" stroke-linecap="round"/>

          <!-- Superior frontal MCA branch — climbs toward vertex -->
          <path d="M 118,186 C 115,160 112,132 116,104 C 120,78 130,56 142,36"
                stroke="rgba(148,52,38,0.36)" stroke-width="0.9" stroke-linecap="round"/>

          <!-- Pre-Rolandic branch — ascending to motor strip -->
          <path d="M 156,182 C 154,154 152,120 154,92 C 156,66 164,44 176,26"
                stroke="rgba(148,52,38,0.34)" stroke-width="0.85" stroke-linecap="round"/>

          <!-- Rolandic (central) branch -->
          <path d="M 198,182 C 196,152 195,118 197,90 C 199,65 205,40 211,20"
                stroke="rgba(148,52,38,0.30)" stroke-width="0.8" stroke-linecap="round"/>

          <!-- Angular artery — posterior MCA toward angular gyrus -->
          <path d="M 298,196 C 316,186 334,178 348,174 C 360,170 372,167 380,162"
                stroke="rgba(148,52,38,0.32)" stroke-width="0.85" stroke-linecap="round"/>

          <!-- Posterior temporal MCA branch — lateral occipital direction -->
          <path d="M 322,198 C 338,186 356,174 370,166 C 382,158 394,152 404,142"
                stroke="rgba(148,52,38,0.28)" stroke-width="0.8" stroke-linecap="round"/>

          <!-- Temporal descending branches — over superior temporal gyrus -->
          <path d="M 168,186 C 162,198 155,212 148,226 C 140,240 135,252 134,262"
                stroke="rgba(148,52,38,0.30)" stroke-width="0.8" stroke-linecap="round"/>
          <path d="M 220,188 C 218,202 215,218 215,232 C 215,246 217,257 220,265"
                stroke="rgba(148,52,38,0.26)" stroke-width="0.75" stroke-linecap="round"/>

          <!-- Small anastomotic connectors across gyral crowns -->
          <path d="M 134,152 C 148,148 160,146 174,149"
                stroke="rgba(148,52,38,0.20)" stroke-width="0.65" stroke-linecap="round"/>
          <path d="M 248,138 C 262,134 276,133 287,137"
                stroke="rgba(148,52,38,0.20)" stroke-width="0.65" stroke-linecap="round"/>
          <path d="M 330,138 C 344,132 358,130 368,134"
                stroke="rgba(148,52,38,0.18)" stroke-width="0.65" stroke-linecap="round"/>

          <!-- PICA — superior cerebellar loop (visible on dorsal cerebellum surface) -->
          <path d="M 292,284 C 312,278 334,275 355,279 C 374,283 392,292 406,306"
                stroke="rgba(148,52,38,0.30)" stroke-width="0.8" stroke-linecap="round"/>
          <!-- PICA lateral loop — left cerebellar hemisphere -->
          <path d="M 320,277 C 324,293 326,312 322,330 C 318,346 310,358 300,364"
                stroke="rgba(148,52,38,0.24)" stroke-width="0.75" stroke-linecap="round"/>
          <!-- PICA right loop -->
          <path d="M 368,282 C 376,298 380,318 374,336 C 368,352 354,362 338,366"
                stroke="rgba(148,52,38,0.22)" stroke-width="0.7" stroke-linecap="round"/>

        </g>

        <!-- ══ SULCI + GYRI TEXTURE (pointer-events: none) ══ -->
        <g class="texture-layer" pointer-events="none" fill="none">

          <!-- ─── TIER 1: PRIMARY SULCI — deepest grooves, full shadow filter ─── -->
          <g filter="url(#f-sulcal)">
            <!-- Central sulcus — precentral / postcentral boundary -->
            <path d="M 212,19 C 211,50 212,90 213,132 C 214,158 215,174 215,188"
                  stroke="rgba(22,5,2,0.92)" stroke-width="3.2" stroke-linecap="round"/>
            <!-- Sylvian (lateral) fissure — deepest sulcus on lateral surface -->
            <path d="M 104,196 C 130,190 160,186 188,184 C 204,183 211,184 215,188
                     C 240,185 270,185 296,191 C 305,194 311,199 315,204"
                  stroke="rgba(22,5,2,0.90)" stroke-width="3.4" stroke-linecap="round"/>
            <!-- Parieto-occipital sulcus -->
            <path d="M 378,52 C 396,84 408,118 413,154 C 415,178 414,202 407,226
                     C 400,244 388,258 374,268 C 367,273 362,277 360,280"
                  stroke="rgba(22,5,2,0.84)" stroke-width="2.8" stroke-linecap="round"/>
            <!-- Pre-central sulcus (just anterior to motor strip) -->
            <path d="M 192,22 C 191,58 189,100 188,142 C 187,164 184,180 180,192"
                  stroke="rgba(22,5,2,0.78)" stroke-width="2.5" stroke-linecap="round"/>
            <!-- Post-central sulcus (just posterior to sensory strip) -->
            <path d="M 243,18 C 242,54 241,100 240,148 C 240,176 241,210 244,240
                     C 246,256 248,266 250,272"
                  stroke="rgba(22,5,2,0.76)" stroke-width="2.4" stroke-linecap="round"/>
            <!-- Superior frontal sulcus (horizontal, major frontal landmark) -->
            <path d="M 68,58 C 86,52 106,47 128,46 C 148,45 166,46 182,48 C 190,49 194,52 194,56"
                  stroke="rgba(22,5,2,0.74)" stroke-width="2.4" stroke-linecap="round"/>
            <!-- Intraparietal sulcus (diagonal across upper parietal) -->
            <path d="M 248,54 C 264,72 285,94 308,118 C 328,140 347,164 360,192
                     C 366,208 368,226 365,244"
                  stroke="rgba(22,5,2,0.74)" stroke-width="2.3" stroke-linecap="round"/>
            <!-- Superior temporal sulcus (long horizontal below Sylvian) -->
            <path d="M 107,216 C 138,211 172,209 206,211 C 236,213 264,220 290,230
                     C 304,236 314,241 320,244"
                  stroke="rgba(22,5,2,0.70)" stroke-width="2.2" stroke-linecap="round"/>
          </g>

          <!-- ─── TIER 2: SECONDARY SULCI — standard depth shadow ─── -->
          <g filter="url(#f-sulcal)" opacity="0.84">
            <!-- ── Frontal secondary sulci ── -->
            <!-- Middle frontal sulcus (horizontal, middle of frontal lobe) -->
            <path d="M 46,94 C 65,87 88,83 112,82 C 133,82 152,82 168,84 C 180,86 188,90 192,96"
                  stroke="rgba(32,8,4,0.66)" stroke-width="1.9" stroke-linecap="round"/>
            <!-- Inferior frontal sulcus (below middle, above Sylvian) -->
            <path d="M 42,136 C 62,129 84,125 106,123 C 124,122 140,122 152,126
                     C 160,130 164,138 162,148"
                  stroke="rgba(32,8,4,0.62)" stroke-width="1.8" stroke-linecap="round"/>
            <!-- Orbital sulcus (lower anterior frontal) -->
            <path d="M 42,168 C 58,162 76,158 96,158 C 110,158 122,162 130,170"
                  stroke="rgba(32,8,4,0.54)" stroke-width="1.6" stroke-linecap="round"/>
            <!-- Fronto-orbital short sulcus -->
            <path d="M 60,184 C 74,180 90,178 108,180"
                  stroke="rgba(32,8,4,0.46)" stroke-width="1.4" stroke-linecap="round"/>
            <!-- Transverse frontal gyrus connectors (cross-gyrus links) -->
            <path d="M 66,66 C 76,59 88,55 102,53"
                  stroke="rgba(32,8,4,0.50)" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M 68,104 C 80,98 96,96 114,96"
                  stroke="rgba(32,8,4,0.46)" stroke-width="1.4" stroke-linecap="round"/>
            <path d="M 60,144 C 74,140 90,138 110,138"
                  stroke="rgba(32,8,4,0.42)" stroke-width="1.3" stroke-linecap="round"/>
            <!-- Short frontal cap (anterior pole gyri) -->
            <path d="M 46,116 C 50,104 52,94 52,82"
                  stroke="rgba(32,8,4,0.42)" stroke-width="1.3" stroke-linecap="round"/>
            <path d="M 48,156 C 44,144 42,132 44,120"
                  stroke="rgba(32,8,4,0.38)" stroke-width="1.2" stroke-linecap="round"/>

            <!-- ── Parietal secondary sulci ── -->
            <!-- Superior parietal lobule long sulcus -->
            <path d="M 254,32 C 275,44 300,58 325,76 C 344,92 358,112 363,134"
                  stroke="rgba(32,8,4,0.62)" stroke-width="1.8" stroke-linecap="round"/>
            <!-- Supramarginal gyrus arc -->
            <path d="M 296,142 C 310,150 322,164 328,182 C 332,198 328,214 318,224"
                  stroke="rgba(32,8,4,0.58)" stroke-width="1.6" stroke-linecap="round"/>
            <!-- Angular gyrus sulcus -->
            <path d="M 332,144 C 344,150 354,166 356,184 C 356,200 350,214 340,222"
                  stroke="rgba(32,8,4,0.54)" stroke-width="1.5" stroke-linecap="round"/>
            <!-- Parietal transverse short links -->
            <path d="M 254,78 C 270,82 290,86 310,94"
                  stroke="rgba(32,8,4,0.48)" stroke-width="1.4" stroke-linecap="round"/>
            <path d="M 252,120 C 270,124 292,130 312,140"
                  stroke="rgba(32,8,4,0.46)" stroke-width="1.3" stroke-linecap="round"/>
            <path d="M 252,164 C 268,165 286,168 304,176"
                  stroke="rgba(32,8,4,0.42)" stroke-width="1.3" stroke-linecap="round"/>
            <path d="M 252,200 C 266,200 282,202 298,208"
                  stroke="rgba(32,8,4,0.40)" stroke-width="1.2" stroke-linecap="round"/>
            <path d="M 254,234 C 270,230 288,230 304,236"
                  stroke="rgba(32,8,4,0.38)" stroke-width="1.2" stroke-linecap="round"/>

            <!-- ── Temporal secondary sulci ── -->
            <!-- Middle temporal sulcus (long horizontal) -->
            <path d="M 118,244 C 155,239 196,237 234,243 C 260,248 284,256 308,264"
                  stroke="rgba(32,8,4,0.60)" stroke-width="1.7" stroke-linecap="round"/>
            <!-- Inferior temporal sulcus -->
            <path d="M 128,270 C 162,265 200,263 235,268 C 258,272 280,278 300,283"
                  stroke="rgba(32,8,4,0.48)" stroke-width="1.5" stroke-linecap="round"/>
            <!-- Transverse temporal (cross-gyrus vertical links) -->
            <path d="M 124,220 C 122,236 122,252 124,266"
                  stroke="rgba(32,8,4,0.40)" stroke-width="1.3" stroke-linecap="round"/>
            <path d="M 158,216 C 156,232 156,250 158,266"
                  stroke="rgba(32,8,4,0.38)" stroke-width="1.2" stroke-linecap="round"/>
            <path d="M 196,213 C 196,229 198,247 200,263"
                  stroke="rgba(32,8,4,0.38)" stroke-width="1.2" stroke-linecap="round"/>
            <path d="M 234,218 C 236,234 238,252 238,267"
                  stroke="rgba(32,8,4,0.36)" stroke-width="1.2" stroke-linecap="round"/>
            <path d="M 268,224 C 270,240 272,256 270,270"
                  stroke="rgba(32,8,4,0.34)" stroke-width="1.1" stroke-linecap="round"/>
            <path d="M 296,232 C 298,246 298,260 295,273"
                  stroke="rgba(32,8,4,0.34)" stroke-width="1.1" stroke-linecap="round"/>

            <!-- ── Occipital secondary sulci ── -->
            <!-- Lateral occipital sulcus 1 -->
            <path d="M 396,74 C 405,98 411,128 411,158 C 409,184 403,208 394,228"
                  stroke="rgba(32,8,4,0.58)" stroke-width="1.6" stroke-linecap="round"/>
            <!-- Lateral occipital sulcus 2 -->
            <path d="M 418,88 C 426,112 430,142 428,170 C 425,196 416,220 405,238"
                  stroke="rgba(32,8,4,0.52)" stroke-width="1.5" stroke-linecap="round"/>
            <!-- Lateral occipital sulcus 3 (outer) -->
            <path d="M 436,112 C 441,136 441,162 436,186 C 430,208 420,228 408,242"
                  stroke="rgba(32,8,4,0.44)" stroke-width="1.4" stroke-linecap="round"/>
            <!-- Inferior occipital sulcus -->
            <path d="M 386,228 C 394,240 400,254 404,264"
                  stroke="rgba(32,8,4,0.42)" stroke-width="1.3" stroke-linecap="round"/>
            <!-- Occipital transverse links -->
            <path d="M 396,98 C 408,94 420,92 430,94"
                  stroke="rgba(32,8,4,0.38)" stroke-width="1.2" stroke-linecap="round"/>
            <path d="M 394,138 C 406,136 418,136 428,140"
                  stroke="rgba(32,8,4,0.36)" stroke-width="1.2" stroke-linecap="round"/>
            <path d="M 390,178 C 402,176 414,176 424,180"
                  stroke="rgba(32,8,4,0.36)" stroke-width="1.1" stroke-linecap="round"/>
            <path d="M 384,218 C 396,216 408,218 416,222"
                  stroke="rgba(32,8,4,0.34)" stroke-width="1.1" stroke-linecap="round"/>
          </g>

          <!-- ─── TIER 3: GYRI RIDGE HIGHLIGHTS with warm glow filter ─── -->
          <g filter="url(#f-gyrus)">
            <!-- Superior lit crest — top of brain catching overhead light -->
            <path d="M 84,24 C 110,17 148,13 186,14 C 210,15 230,18 248,22"
                  stroke="rgba(255,238,222,0.70)" stroke-width="1.8" stroke-linecap="round"/>
            <!-- Frontal gyral crowns (lit ridges between sulci) -->
            <path d="M 54,40 C 72,34 92,30 114,30 C 132,30 150,32 168,36 C 180,40 190,44 196,50"
                  stroke="rgba(255,232,216,0.65)" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M 48,76 C 66,70 88,66 110,66 C 130,66 148,66 164,68 C 176,70 186,74 192,80"
                  stroke="rgba(255,228,212,0.55)" stroke-width="1.3" stroke-linecap="round"/>
            <path d="M 44,114 C 62,108 82,104 104,104 C 122,104 140,104 156,106
                     C 168,108 178,112 188,118"
                  stroke="rgba(255,224,208,0.48)" stroke-width="1.2" stroke-linecap="round"/>
            <path d="M 42,152 C 60,146 80,142 100,142 C 118,142 134,142 148,144
                     C 160,146 170,152 178,158"
                  stroke="rgba(255,220,204,0.42)" stroke-width="1.1" stroke-linecap="round"/>
            <path d="M 44,182 C 60,176 78,172 96,172 C 112,172 126,174 138,180"
                  stroke="rgba(255,216,200,0.36)" stroke-width="1.0" stroke-linecap="round"/>
            <!-- Parietal gyral crowns -->
            <path d="M 240,25 C 260,30 285,40 310,52 C 330,64 348,78 360,94"
                  stroke="rgba(255,228,212,0.62)" stroke-width="1.4" stroke-linecap="round"/>
            <path d="M 243,68 C 264,74 288,84 312,98 C 332,110 348,128 355,148"
                  stroke="rgba(255,224,208,0.52)" stroke-width="1.2" stroke-linecap="round"/>
            <path d="M 246,110 C 266,114 290,124 312,138 C 329,150 342,166 348,184"
                  stroke="rgba(255,220,204,0.44)" stroke-width="1.1" stroke-linecap="round"/>
            <path d="M 252,152 C 268,156 288,164 306,176 C 320,186 330,200 334,216"
                  stroke="rgba(255,216,200,0.38)" stroke-width="1.0" stroke-linecap="round"/>
            <path d="M 254,198 C 270,198 288,202 304,210 C 316,218 326,230 330,244"
                  stroke="rgba(255,212,196,0.32)" stroke-width="0.9" stroke-linecap="round"/>
            <!-- Temporal gyral crowns -->
            <path d="M 112,222 C 148,218 186,216 222,222 C 248,226 272,232 292,240"
                  stroke="rgba(255,222,206,0.48)" stroke-width="1.2" stroke-linecap="round"/>
            <path d="M 122,252 C 156,247 194,245 230,251 C 254,255 276,263 294,271"
                  stroke="rgba(255,218,202,0.40)" stroke-width="1.1" stroke-linecap="round"/>
            <path d="M 132,278 C 162,274 198,272 232,277 C 256,281 278,287 298,293"
                  stroke="rgba(255,214,198,0.32)" stroke-width="0.9" stroke-linecap="round"/>
            <!-- Occipital gyral crowns -->
            <path d="M 380,62 C 392,80 400,104 404,132 C 406,156 403,180 396,202"
                  stroke="rgba(255,216,200,0.44)" stroke-width="1.1" stroke-linecap="round"/>
            <path d="M 406,84 C 415,106 420,134 418,162 C 415,188 408,212 398,232"
                  stroke="rgba(255,212,196,0.36)" stroke-width="1.0" stroke-linecap="round"/>
            <path d="M 428,108 C 434,132 434,160 428,186 C 422,208 412,228 400,244"
                  stroke="rgba(255,208,192,0.30)" stroke-width="0.9" stroke-linecap="round"/>
          </g>

          <!-- ─── CEREBELLUM FOLIA (dense transverse stripes) ─── -->
          <g clip-path="url(#clip-cb)">
            <line x1="260" y1="284" x2="448" y2="284" stroke="rgba(255,210,190,0.22)" stroke-width="0.8"/>
            <line x1="260" y1="291" x2="450" y2="291" stroke="rgba(32,8,4,0.58)" stroke-width="1.8"/>
            <line x1="260" y1="298" x2="452" y2="298" stroke="rgba(255,210,190,0.26)" stroke-width="0.9"/>
            <line x1="260" y1="305" x2="452" y2="305" stroke="rgba(32,8,4,0.56)" stroke-width="1.7"/>
            <line x1="260" y1="312" x2="453" y2="312" stroke="rgba(255,208,188,0.24)" stroke-width="0.8"/>
            <line x1="260" y1="319" x2="452" y2="319" stroke="rgba(32,8,4,0.54)" stroke-width="1.7"/>
            <line x1="260" y1="326" x2="450" y2="326" stroke="rgba(255,206,186,0.22)" stroke-width="0.8"/>
            <line x1="260" y1="333" x2="448" y2="333" stroke="rgba(32,8,4,0.52)" stroke-width="1.6"/>
            <line x1="260" y1="340" x2="444" y2="340" stroke="rgba(255,204,184,0.20)" stroke-width="0.8"/>
            <line x1="260" y1="347" x2="440" y2="347" stroke="rgba(32,8,4,0.50)" stroke-width="1.5"/>
            <line x1="260" y1="354" x2="434" y2="354" stroke="rgba(255,200,180,0.16)" stroke-width="0.7"/>
          </g>
        </g>

        <!-- ══ DEPTH REFINEMENTS (pointer-events: none) ══ -->
        <g pointer-events="none" fill="none">

          <!-- ── Sulcal valley shadow twins (dark second echo beside each primary sulcus) ── -->
          <g filter="url(#f-sulcal)" opacity="0.55">
            <path d="M 217,22 C 216,72 218,132 220,190"
                  stroke="rgba(18,4,2,0.80)" stroke-width="1.0" stroke-linecap="round"/>
            <path d="M 104,200 C 148,191 196,188 216,192 C 252,189 285,191 315,208"
                  stroke="rgba(18,4,2,0.80)" stroke-width="1.0" stroke-linecap="round"/>
            <path d="M 374,54 C 396,104 409,150 411,188 C 411,214 398,238 380,254 C 368,266 360,274 356,282"
                  stroke="rgba(18,4,2,0.72)" stroke-width="0.9" stroke-linecap="round"/>
          </g>

          <!-- ── Lobe-boundary lit edges (gyrus peaks facing upper-left light) ── -->
          <g filter="url(#f-gyrus)" opacity="0.9">
            <path d="M 209,22 C 208,72 210,132 212,190"
                  stroke="rgba(255,230,215,0.60)" stroke-width="1.3" stroke-linecap="round"/>
            <path d="M 221,22 C 220,72 222,132 224,190"
                  stroke="rgba(255,240,225,0.22)" stroke-width="1.0" stroke-linecap="round"/>
            <path d="M 105,193 C 149,184 197,181 215,185 C 252,182 285,184 315,201"
                  stroke="rgba(255,235,220,0.22)" stroke-width="1.0" stroke-linecap="round"/>
            <path d="M 378,52 C 400,102 412,148 415,186"
                  stroke="rgba(255,226,210,0.50)" stroke-width="1.2" stroke-linecap="round"/>
          </g>

          <!-- ── Sub-region inner rim highlights ── -->
          <path d="M 43,153 C 41,117 54,72 87,47 C 109,30 137,20 165,20"
                stroke="rgba(255,226,210,0.48)" stroke-width="1.1" stroke-linecap="round"/>
          <path d="M 105,195 C 116,189 130,185 149,186"
                stroke="rgba(255,235,222,0.24)" stroke-width="1.1" stroke-linecap="round"/>
          <path d="M 316,204 C 323,196 340,192 355,199"
                stroke="rgba(255,235,222,0.24)" stroke-width="1.1" stroke-linecap="round"/>

          <!-- ── Brainstem segmentation lines ── -->
          <path d="M 233,302 C 245,300 261,299 281,302"
                stroke="rgba(48,12,8,0.62)" stroke-width="1.6" stroke-linecap="round"/>
          <path d="M 233,301 C 245,299 261,298 281,301"
                stroke="rgba(255,255,255,0.13)" stroke-width="0.7" stroke-linecap="round"/>
          <path d="M 230,320 C 243,317 258,316 281,320"
                stroke="rgba(48,12,8,0.56)" stroke-width="1.5" stroke-linecap="round"/>
          <path d="M 230,319 C 243,316 258,315 281,319"
                stroke="rgba(255,215,195,0.24)" stroke-width="0.7" stroke-linecap="round"/>
          <path d="M 239,284 C 229,301 225,322 227,341"
                stroke="rgba(255,255,255,0.22)" stroke-width="1.1" stroke-linecap="round"/>

          <!-- ── Cerebellum superior rim + vermis ── -->
          <path d="M 285,280 C 315,275 345,275 372,281 C 400,286 428,296 445,314"
                stroke="rgba(255,228,210,0.32)" stroke-width="1.4" stroke-linecap="round"/>
          <path d="M 357,278 C 358,296 357,316 354,336 C 351,349 345,358 337,360"
                stroke="rgba(48,12,8,0.58)" stroke-width="1.3" stroke-linecap="round"
                stroke-dasharray="3 4"/>

          <!-- ── Lower hemisphere vignette ── -->
          <path d="M 270,280 C 295,268 318,278 342,286
                   C 370,296 400,292 422,280 C 448,264 462,222 460,174
                   C 440,188 415,210 395,234 C 375,256 355,270 332,278
                   C 308,284 288,282 270,280 Z"
                fill="rgba(28,7,3,0.24)"/>

        </g>

        <!-- ══ CORTICAL SURFACE TEXTURE (pointer-events: none) ══ -->
        <!-- feTurbulence fractal-noise creates organic micro-texture on the brain surface.
             The f-cortex filter clips the noise to the source shape and layers it as a warm
             organic overlay — the key ingredient for moving from "diagram" to "tissue". -->
        <g pointer-events="none" filter="url(#f-cortex)">
          <!-- Main hemisphere -->
          <path d="M 212,18 C 168,14 118,22 85,46 C 55,68 38,110 40,155
                   C 40,178 48,198 72,204 C 88,210 102,204 104,196
                   C 148,187 196,184 215,188 C 252,185 285,187 315,204
                   C 317,238 323,254 360,280 C 382,298 405,293 425,282
                   C 450,265 465,225 462,180 C 456,132 422,82 378,52
                   C 330,26 265,14 212,18 Z"
                fill="rgba(148,58,24,0.38)" stroke="none"/>
          <!-- Cerebellum -->
          <path d="M 285,280 C 315,275 345,275 372,281 C 400,286 428,296 445,314
                   C 450,330 445,347 426,354 C 406,361 378,362 350,356
                   C 324,350 298,338 280,324 C 264,312 262,298 272,286
                   C 276,282 280,280 285,280 Z"
                fill="rgba(130,52,22,0.32)" stroke="none"/>
          <!-- Brainstem -->
          <path d="M 238,283 C 254,278 270,278 284,284 C 288,298 288,318 282,338
                   C 276,352 265,358 252,356 C 240,354 228,348 225,334
                   C 222,318 224,298 238,283 Z"
                fill="rgba(110,46,26,0.26)" stroke="none"/>
        </g>

        <!-- ══ LIGHTING OVERLAYS (pointer-events: none) ══ -->
        <!-- Full-brain fill overlays removed — regions are now separated;
             per-region radial gradients + CSS drop-shadow handle all 3D depth. -->
      </svg>
    </div>

    <!-- Study mode prompt (hidden during quiz) -->
    <div class="study-prompt" id="study-prompt" style="display:none">
      Click any region to explore its <strong>anatomy</strong> and <strong>clinical syndromes</strong>
    </div>

    <!-- Answer chips (type 2 only) -->
    <div class="chips-answer-wrap" id="chips-answer-wrap" style="display:none"></div>

    <!-- Actions -->
    <div class="action-row">
      <button class="submit-btn" id="submit-btn" onclick="handleSubmit()">Submit Answer</button>
      <button class="next-btn"   id="next-btn"   onclick="nextQuestion()">Next &rarr;</button>
    </div>

    <!-- Explanation -->
    <div class="explanation-box" id="explanation-box">
      <div class="explanation-verdict" id="explanation-verdict"></div>
      <div class="explanation-text" id="explanation-text"></div>
    </div>
  </div>

  <!-- RESULTS -->
  <div class="screen" id="screen-results">
    <div class="results-card">
      <div class="score-ring" id="score-ring">
        <div class="score-ring-inner">
          <span class="score-pct" id="score-pct">0%</span>
          <span class="score-sub">Score</span>
        </div>
      </div>
      <div class="results-title">Session Complete</div>
      <div class="results-detail" id="results-detail"></div>
      <div class="results-actions">
        <button class="btn-primary" onclick="location.href='brain-settings.html'">New Session</button>
        <button class="btn-secondary" id="review-btn" onclick="showReview()" style="display:none">Review Missed</button>
      </div>
    </div>
  </div>

  <!-- REVIEW -->
  <div class="screen" id="screen-review">
    <div class="review-header">Missed Questions — Review</div>
    <div id="review-items"></div>
    <button class="review-back-btn" onclick="showResults()">&larr; Back to Results</button>
  </div>

  <!-- Info panel (study mode) -->
  <div class="info-panel" id="info-panel">
    <div class="info-panel-inner">
      <button class="info-close" onclick="closeInfoPanel()" aria-label="Close">&#215;</button>
      <div class="info-region-name" id="info-region-name"></div>
      <div class="info-ba" id="info-ba-row">
        <span class="info-meta-label">Brodmann Areas</span>
        <span id="info-ba-val"></span>
      </div>
      <div class="info-cols">
        <div class="info-col">
          <div class="info-section-label">Key Functions</div>
          <ul class="info-list" id="info-functions"></ul>
        </div>
        <div class="info-col">
          <div class="info-section-label">Clinical Syndromes</div>
          <ul class="info-list" id="info-syndromes"></ul>
        </div>
      </div>
      <div class="info-vascular" id="info-vascular-row">
        <span class="info-meta-label">Vascular Territory</span>
        <span id="info-vascular-val"></span>
      </div>
    </div>
  </div>

  <script src="data/brain_data.js"></script>
  <script>
  (function () {
    'use strict';

    // ── Parse URL params ──────────────────────────────────────────────────
    const params     = new URLSearchParams(location.search);
    const CATS_RAW   = (params.get('categories') || '').split(',').filter(Boolean);
    const COUNT_RAW  = parseInt(params.get('count') || '20', 10);
    const CATEGORIES = CATS_RAW.length ? CATS_RAW : null;
    const IS_STUDY   = params.get('mode') === 'study';

    // ── Data ──────────────────────────────────────────────────────────────
    const DATA      = window.__BRAIN_DATA || {};
    const REGIONS   = DATA.regions || {};
    const ALL_QS    = DATA.questions || [];

    // ── State ─────────────────────────────────────────────────────────────
    let pool         = [];
    let current      = 0;
    let correctCount = 0;
    let missed       = [];
    let selectedRegion  = null;
    let selectedChipIdx = null;
    let submitted    = false;

    // ── Session key for localStorage ─────────────────────────────────────
    const SESSION_KEY = 'brain_session_' + JSON.stringify({
      cats: CATEGORIES ? [...CATEGORIES].sort().join(',') : 'all',
      n: COUNT_RAW
    });

    // ── Helpers ───────────────────────────────────────────────────────────
    function shuffle(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function regionEl(id) { return document.getElementById(id); }
    function regionLabel(id) { return (REGIONS[id] || {}).label || id; }

    // ── Build pool ────────────────────────────────────────────────────────
    function buildPool() {
      let qs = ALL_QS.slice();
      if (CATEGORIES) {
        qs = qs.filter(q => CATEGORIES.includes(q.category));
      }
      qs = shuffle(qs);
      if (COUNT_RAW > 0) qs = qs.slice(0, COUNT_RAW);
      return qs;
    }

    // ── Study mode ────────────────────────────────────────────────────────
    function initStudy() {
      showScreen('screen-quiz');
      // Hide all quiz-only elements
      document.querySelector('.progress-wrap').style.display = 'none';
      document.querySelector('.question-card').style.display = 'none';
      document.getElementById('chips-answer-wrap').style.display = 'none';
      document.querySelector('.action-row').style.display = 'none';
      document.getElementById('explanation-box').style.display = 'none';
      document.getElementById('nav-score').style.display = 'none';
      // Show study prompt
      document.getElementById('study-prompt').style.display = 'block';
      // All regions active + wired
      const svg = document.getElementById('brain-svg');
      svg.classList.add('svg-study-mode');
      document.querySelectorAll('.brain-region').forEach(g => {
        g.classList.add('region-active');
        g.onclick = () => handleStudyRegionClick(g);
      });
    }

    function handleStudyRegionClick(g) {
      const regionId = g.dataset.region;
      const rData    = REGIONS[regionId];
      if (!rData) return;
      // Update selection highlight
      document.querySelectorAll('.brain-region').forEach(el => el.classList.remove('study-selected'));
      g.classList.add('study-selected');
      populateInfoPanel(rData.label, rData.info || {});
      document.getElementById('info-panel').classList.add('open');
    }

    function populateInfoPanel(label, info) {
      document.getElementById('info-region-name').textContent = label;
      const baRow = document.getElementById('info-ba-row');
      if (info.ba) {
        document.getElementById('info-ba-val').textContent = info.ba;
        baRow.style.display = '';
      } else {
        baRow.style.display = 'none';
      }
      document.getElementById('info-functions').innerHTML =
        (info.functions || []).map(f => `<li>${f}</li>`).join('');
      document.getElementById('info-syndromes').innerHTML =
        (info.syndromes || []).map(s => `<li>${s}</li>`).join('');
      const vRow = document.getElementById('info-vascular-row');
      if (info.vascular) {
        document.getElementById('info-vascular-val').textContent = info.vascular;
        vRow.style.display = '';
      } else {
        vRow.style.display = 'none';
      }
    }

    // ── Init ─────────────────────────────────────────────────────────────
    function init() {
      if (IS_STUDY) { initStudy(); return; }
      // Try restore session
      try {
        const saved = JSON.parse(localStorage.getItem(SESSION_KEY));
        if (saved && saved.pool && saved.current < saved.pool.length) {
          pool         = saved.pool;
          current      = saved.current;
          correctCount = saved.correctCount || 0;
          missed       = saved.missed || [];
          showScreen('screen-quiz');
          renderQuestion();
          return;
        }
      } catch (e) { /* ignore */ }

      pool = buildPool();
      if (!pool.length) {
        showScreen('screen-quiz');
        document.getElementById('q-text').textContent = 'No questions match your selection. Go back and try different categories.';
        return;
      }
      showScreen('screen-quiz');
      renderQuestion();
    }

    function saveSession() {
      try {
        localStorage.setItem(SESSION_KEY, JSON.stringify({ pool, current, correctCount, missed }));
      } catch (e) { /* ignore */ }
    }

    function clearSession() {
      try { localStorage.removeItem(SESSION_KEY); } catch (e) { /* ignore */ }
    }

    // ── Screen management ─────────────────────────────────────────────────
    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    // ── Progress bar ──────────────────────────────────────────────────────
    function updateProgress() {
      const pct = pool.length ? (current / pool.length) * 100 : 0;
      document.getElementById('progress-fill').style.width = pct + '%';
      document.getElementById('progress-label').textContent =
        `Question ${Math.min(current + 1, pool.length)} of ${pool.length}`;
      document.getElementById('progress-correct').textContent = '✓ ' + correctCount;
      document.getElementById('nav-score').style.display = 'flex';
      document.getElementById('nav-correct').textContent = correctCount;
      document.getElementById('nav-total').textContent = current;
    }

    // ── Reset SVG state ───────────────────────────────────────────────────
    function resetSVG() {
      Object.keys(REGIONS).forEach(id => {
        const el = regionEl(id);
        if (!el) return;
        el.classList.remove(
          'region-active','region-dimmed','region-selected',
          'region-highlighted','region-correct','region-wrong'
        );
      });
    }

    function setAllDimmed() {
      Object.keys(REGIONS).forEach(id => {
        const el = regionEl(id);
        if (el) el.classList.add('region-dimmed');
      });
    }

    function activateRegions(ids) {
      ids.forEach(id => {
        const el = regionEl(id);
        if (el) {
          el.classList.remove('region-dimmed');
          el.classList.add('region-active');
        }
      });
    }

    // ── Render question ───────────────────────────────────────────────────
    function renderQuestion() {
      if (current >= pool.length) { showResults(); return; }

      const q = pool[current];
      selectedRegion  = null;
      selectedChipIdx = null;
      submitted       = false;

      updateProgress();
      resetSVG();

      // Reset UI elements
      document.getElementById('chips-answer-wrap').style.display = 'none';
      document.getElementById('chips-answer-wrap').innerHTML = '';
      document.getElementById('highlighted-label').style.display = 'none';
      document.getElementById('explanation-box').className = 'explanation-box';
      document.getElementById('explanation-text').textContent = '';
      document.getElementById('explanation-verdict').textContent = '';
      document.getElementById('submit-btn').classList.remove('visible');
      document.getElementById('next-btn').classList.remove('visible');
      document.getElementById('submit-btn').disabled = false;

      // Category label
      const catLabels = {
        aphasia:'Aphasia', motor:'Motor / Movement', memory:'Memory',
        visual:'Visual', sensory:'Sensory / Perceptual',
        executive:'Executive / Frontal', vascular:'Vascular'
      };
      document.getElementById('q-label').textContent =
        (catLabels[q.category] || q.category) + ' — Brain Pathology';

      if (q.type === 'deficit_to_location' || q.type === 'case_to_location') {
        renderClickRegion(q);
      } else if (q.type === 'location_to_deficit') {
        renderLocationToDeficit(q);
      }

      saveSession();
    }

    // ── Type 1 & 3: click a region ────────────────────────────────────────
    function renderClickRegion(q) {
      document.getElementById('q-text').textContent = q.question;

      const activeIds = [q.target_region, ...(q.distractor_regions || [])];
      setAllDimmed();
      activateRegions(activeIds);

      // Wire click handlers
      activeIds.forEach(id => {
        const el = regionEl(id);
        if (!el) return;
        el.onclick = () => handleRegionClick(id, q);
      });
    }

    // ── Type 2: highlighted region + chips ────────────────────────────────
    function renderLocationToDeficit(q) {
      document.getElementById('q-text').textContent = q.question;

      const highlighted = q.highlighted_region;
      setAllDimmed();
      const hEl = regionEl(highlighted);
      if (hEl) {
        hEl.classList.remove('region-dimmed');
        hEl.classList.add('region-highlighted');
      }
      document.getElementById('highlighted-label').style.display = 'block';
      document.getElementById('highlighted-label').textContent =
        '★ ' + regionLabel(highlighted) + ' — highlighted';

      // Render chips
      const wrap = document.getElementById('chips-answer-wrap');
      wrap.style.display = 'flex';
      const shuffledOpts = q.options.map((text, i) => ({ text, origIdx: i }));
      // Keep options in original order for location_to_deficit (they're written to match)
      shuffledOpts.forEach(({ text, origIdx }) => {
        const chip = document.createElement('button');
        chip.className = 'answer-chip';
        chip.textContent = text;
        chip.dataset.idx = origIdx;
        chip.onclick = () => handleChipClick(origIdx, q, chip);
        wrap.appendChild(chip);
      });
    }

    // ── Handlers ─────────────────────────────────────────────────────────
    function handleRegionClick(id, q) {
      if (submitted) return;
      selectedRegion = id;

      // Visual: deselect all, then select clicked
      Object.keys(REGIONS).forEach(rid => {
        const el = regionEl(rid);
        if (el) el.classList.remove('region-selected');
      });
      const el = regionEl(id);
      if (el) el.classList.add('region-selected');

      document.getElementById('submit-btn').classList.add('visible');
    }

    function handleChipClick(idx, q, chipEl) {
      if (submitted) return;
      selectedChipIdx = idx;

      // Visual: deselect all chips
      document.querySelectorAll('.answer-chip').forEach(c => {
        c.classList.remove('chip-selected');
      });
      chipEl.classList.add('chip-selected');

      document.getElementById('submit-btn').classList.add('visible');
    }

    // ── Submit ────────────────────────────────────────────────────────────
    function handleSubmit() {
      if (submitted) return;
      const q = pool[current];

      if (q.type === 'deficit_to_location' || q.type === 'case_to_location') {
        if (!selectedRegion) return;
        submitClickRegion(q);
      } else if (q.type === 'location_to_deficit') {
        if (selectedChipIdx === null) return;
        submitLocationToDeficit(q);
      }

      submitted = true;
      document.getElementById('submit-btn').classList.remove('visible');
      document.getElementById('next-btn').classList.add('visible');
      document.getElementById('submit-btn').disabled = true;
      saveSession();
    }

    function submitClickRegion(q) {
      const isCorrect = selectedRegion === q.target_region;

      if (isCorrect) {
        correctCount++;
        regionEl(selectedRegion).classList.remove('region-selected');
        regionEl(selectedRegion).classList.add('region-correct');
      } else {
        const selEl = regionEl(selectedRegion);
        if (selEl) {
          selEl.classList.remove('region-selected');
          selEl.classList.add('region-wrong');
        }
        const corrEl = regionEl(q.target_region);
        if (corrEl) corrEl.classList.add('region-correct');
        missed.push({ q, selectedRegion });
      }

      showExplanation(q, isCorrect);
    }

    function submitLocationToDeficit(q) {
      const isCorrect = selectedChipIdx === q.correct_option_index;

      document.querySelectorAll('.answer-chip').forEach(chip => {
        chip.classList.add('chip-disabled');
        const i = parseInt(chip.dataset.idx);
        if (i === q.correct_option_index) {
          chip.classList.remove('chip-selected');
          chip.classList.add('chip-correct');
        } else if (i === selectedChipIdx && !isCorrect) {
          chip.classList.remove('chip-selected');
          chip.classList.add('chip-wrong');
        }
      });

      if (isCorrect) {
        correctCount++;
      } else {
        missed.push({ q, selectedChipIdx });
      }

      showExplanation(q, isCorrect);
    }

    function showExplanation(q, isCorrect) {
      const box  = document.getElementById('explanation-box');
      box.className = 'explanation-box visible ' + (isCorrect ? 'correct-box' : 'wrong-box');
      document.getElementById('explanation-verdict').textContent =
        isCorrect ? '✓ Correct' : '✗ Incorrect';
      document.getElementById('explanation-text').textContent = q.explanation;
    }

    // ── Next question ─────────────────────────────────────────────────────
    function nextQuestion() {
      current++;
      renderQuestion();
    }

    // ── Results ───────────────────────────────────────────────────────────
    function showResults() {
      clearSession();
      showScreen('screen-results');

      const total = pool.length;
      const pct = total ? Math.round((correctCount / total) * 100) : 0;

      document.getElementById('score-pct').textContent = pct + '%';
      document.getElementById('score-ring').style.setProperty('--pct', pct + '%');

      document.getElementById('results-detail').innerHTML =
        `You answered <strong>${correctCount}</strong> of <strong>${total}</strong> questions correctly.` +
        (missed.length > 0
          ? `<br><span style="color:var(--rose-light)">${missed.length} missed</span> — review below.`
          : '<br><span style="color:var(--green)">Perfect score!</span>');

      if (missed.length > 0) {
        document.getElementById('review-btn').style.display = 'block';
      }
    }

    // ── Review ────────────────────────────────────────────────────────────
    function showReview() {
      showScreen('screen-review');
      const container = document.getElementById('review-items');
      container.innerHTML = '';

      missed.forEach(({ q }) => {
        const item = document.createElement('div');
        item.className = 'review-item';

        // Question text
        const qDiv = document.createElement('div');
        qDiv.className = 'review-q';
        qDiv.textContent = q.question;
        item.appendChild(qDiv);

        // Mini SVG clone showing correct region in green
        const svgWrap = document.createElement('div');
        svgWrap.className = 'review-brain-wrap';
        const svgEl = document.getElementById('brain-svg').cloneNode(true);
        svgEl.removeAttribute('id');
        svgEl.style.maxWidth = '380px';
        svgEl.style.height = 'auto';

        // Highlight correct region in the clone
        const targetId = q.target_region || q.highlighted_region;
        const cloneG = svgEl.getElementById ? null : svgEl.querySelector('#' + targetId);
        // querySelector on clone
        const cEl = svgEl.querySelector('#' + targetId);
        if (cEl) {
          cEl.querySelectorAll('path, ellipse').forEach(p => {
            p.setAttribute('fill', 'rgba(52,211,153,0.75)');
            p.setAttribute('stroke', '#34d399');
            p.setAttribute('stroke-width', '2.5');
          });
        }
        // Dim everything else
        Object.keys(REGIONS).forEach(rid => {
          if (rid === targetId) return;
          const rEl = svgEl.querySelector('#' + rid);
          if (rEl) rEl.style.opacity = '0.18';
        });
        svgWrap.appendChild(svgEl);
        item.appendChild(svgWrap);

        // Explanation
        const expDiv = document.createElement('div');
        expDiv.className = 'review-explanation';
        expDiv.textContent = q.explanation;
        item.appendChild(expDiv);

        container.appendChild(item);
      });
    }

    // ── Tooltip wiring ────────────────────────────────────────────────────
    const tooltip = document.getElementById('tooltip');
    let tooltipVisible = false;

    document.getElementById('brain-svg').addEventListener('mousemove', e => {
      const g = e.target.closest('.brain-region');
      if (!g) {
        tooltip.classList.remove('visible');
        return;
      }
      const label = g.dataset.label || regionLabel(g.dataset.region);
      tooltip.textContent = label;
      tooltip.classList.add('visible');
      tooltip.style.left = (e.clientX + 14) + 'px';
      tooltip.style.top  = (e.clientY - 28) + 'px';
    });

    document.getElementById('brain-svg').addEventListener('mouseleave', () => {
      tooltip.classList.remove('visible');
    });

    // ── Touch support: convert touch tap to click ─────────────────────────
    let touchStartTarget = null;
    document.getElementById('brain-svg').addEventListener('touchstart', e => {
      touchStartTarget = e.target;
    }, { passive: true });
    document.getElementById('brain-svg').addEventListener('touchend', e => {
      if (e.target === touchStartTarget) {
        const g = e.target.closest('.brain-region');
        if (g) g.click();
      }
    }, { passive: true });

    // Expose for inline buttons
    window.handleSubmit  = handleSubmit;
    window.nextQuestion  = nextQuestion;
    window.showReview    = showReview;
    window.showResults   = showResults;

    // ── Run ───────────────────────────────────────────────────────────────
    init();
  })();

  // closeInfoPanel is called from HTML onclick — must be global
  function closeInfoPanel() {
    document.getElementById('info-panel').classList.remove('open');
    document.querySelectorAll('.brain-region').forEach(el => el.classList.remove('study-selected'));
  }
  </script>
</body>
</html>
